```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r include=FALSE}

library(janitor)
library(tidyverse)
library(ggplot2)
library(ggridges)
theme_set(theme_light())

# The palette with grey:
cbp1 <- c("#999999", "#E69F00", "#56B4E9", "#009E73",
          "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

# The palette with black:
cbp2 <- c("#000000", "#E69F00", "#56B4E9", "#009E73",
          "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

ad_dmg <- function(ap, wpn_spd){
        added_dmg = ap * (wpn_spd/14)
        return(added_dmg)
}

bt <- function(ap){
        damage = ap * 0.45
        return(damage)
}

execute <- function(rage){
        damage = 600 + ((rage-10)*15)
        return(damage)
}

ww <- function(wpn_swing_dmg, wpn_spd, ap)
        {
        additional = ad_dmg(ap, wpn_spd)
        total = wpn_swing_dmg + (additional)
        return(total)
}

rage_gen <- function(damage, conversion = 230.6, hit_factor, wep_speed){
        rage <- ((15*damage) / (4 * conversion)) + ((hit_factor * wep_speed)/2)
}


conversion_values_tbl <- tibble::tribble(
        ~`Player Level`,    ~`Conversion Value`,
                   10,  37.4,
                   20,  72.4,
                   30, 109.3,
                   40, 147.9,
                   50, 188.3,
                   60, 230.6
        )

hit_factor_tbl <- tibble::tribble(
            ~`Weapon`,      ~`Hit Type`,   ~`Hit factor`,
        "Main Hand",   "Normal Hit",  3.5,
        "Main Hand", "Critical Hit",    7,
         "Off Hand",   "Normal Hit", 1.75,
         "Off Hand", "Critical Hit",  3.5
        )

ap_thresh <- as.data.frame(seq(0, 3000, 100))
bt_dmg <- as.data.frame(lapply(ap_thresh, bt))
bt_dmg <- bind_cols(ap_thresh, bt_dmg)
bt_dmg <- bt_dmg %>%
        unnest() %>%
        transmute(AP = `seq(0, 3000, 100)`,
                  Damage = `seq.0..3000..100.`) %>%
        mutate(dpr = Damage/30)

```


# Abilities and Rotation{#abilities}

A warrior's resource is the finite, yet continuously generated, rage. Rage is capped at 100, and the Vanilla WoW Wiki [@vanillawiki_2019] tells us rage is generated by a successful white attack according to the following formula:

\begin{equation}
Rage\ =\ \left(\frac{15\ \times\ D}{4\ \times\ C}\right)\ +\ \left(\frac{\left(Hf\ \times\ Wep_{speed}\right)}{2}\right)\ \le\ \frac{15\ \times\ D}{2}
(\#eq:ragegen)
\end{equation}

Where $D$ is the damage dealt, $C$ is the rage conversion value, $Ws$ is the weapon speed and $Hf$ is the hit factor. The rage conversion value varies by player character level and is dependent on other values such as the mob's hit points and the warrior's expected damage value against that mob. It can be calculated by the following formula:

\begin{equation}
C\ =\ \left(0.0091107836\ \times\ Lvl^2\right)\ +\ \left(3.225598133\ \times\ Lvl\right)\ +\ 4.2652911
(\#eq:convvalue)
\end{equation}

What this tells us is that very low damage attacks have an uppber bound on how much they can be averaged up by the hit factor of the 
Where $Lvl$ is the player's level. Knowing this, we can calculate the conversion value for various level ranges:

```{r echo=FALSE}
knitr::kable(conversion_values_tbl, booktabs = TRUE,
             caption = "Rage conversion values.")
```

Similarly, the hit factor is based on the type of hit you perform against your target:

```{r echo=FALSE}
knitr::kable(hit_factor_tbl, booktabs = TRUE,
             caption = "Hit factor values.")
```

As we can clearly see, critical hits from either hand have a multiplier twice as big as a normal hit.


In any given fight, we will only generate a finite amount of rage. This means that to deal as much damage as we can, in the most efficient way possible, we need to maximize the ratio between damage dealt and rage spent - the **damage per rage** (DPR). This can easily be calculated:

\begin{equation}
DPR\ =\ \frac{Damage}{Rage}
(\#eq:dprformula)
\end{equation}

Although this is an easy concept to grasp, it'll be an essential part of our discussions throughout this chapter from now on. This is because the DPR of our abilities is **not** constant - Whirlwind's (WW) DPR varies depending on the number of enemies around and the damage and type of our weapon, Execute's varies based on how much rage we consume when activating the ability, and Bloodthirst's depends on our current attack power. Doing as much damage as possible in a fight, thus, is about calculating the DPR of each one of these abilities as the encounter progresses, and utilizing the one with the maximum DPR. We will revisit this concept in more depth in \@ref{dpr}


## Bloodthirst{#bloodthirst}


Bloodthirst (BT) is an instant ability on a 6 second cooldown that costs 30 rage and hits the enemy target for 45% of our attack power (AP). Mathematically, we can represent it's damage as:

\begin{equation}
BT_{dmg}\ =\ AP\ \times\ 0.45
(\#eq:btdmg)
\end{equation}

It might not be immediately apparent, but this is one of the main reasons why fury warrior damage scales so well - no other ability in the game benefits from attack power as much as BT. As we will soon see, at 30 rage it has the highest damage per rage of any of our abilities against a single target, and as such should be prioritized in most cases. The formula shows a linear increase in damage, which can be displayed graphically:

```{r echo=FALSE, fig.cap="Bloodthirst scales linearly with attack power and is completely independent of weapon damage."}

ggplot(data = bt_dmg, aes(AP, Damage)) +
        geom_line() +
        geom_point() +
        labs(x = "Attack Power",
             y = "Damage",
             title = "Bloodthirst scales linearly with attack power") +
        scale_x_continuous(breaks = seq(0, 3000, 500))+
        scale_y_continuous(breaks = seq(0, 2000, 150))
```

This complete dependence on AP has another important implication: it means BT damage is completely weapon independent. Two warriors utilizing the same gear except for weapons - with one utilizing a 2 handed weapon and the other a dagger - will deal the same damage with Bloodthirst.


## Whirlwind{#whirlwind}

Whirlwind is an area of effect ability (AoE) that hits four enemy mobs with your currently equipped main hand weapon, on a 10 second cooldown. Its damage can be calculated as:

\begin{equation}
WW_{dmg}\ = Wep_{swing}\ +\ \left(AP\ \times\ \left(\frac{Wep_{speed}}{14}\right)\right)
(\#eq:btdmg)
\end{equation}

Where $Wep_{swing}$ is the damage caused by your weapon swing, and the right term is the damage added to that swing by your AP.
Instantly, we can notice two differences between the damage scaling of WW when compared to BT: it scales with weapon damage, but much more poorly with AP. Another important distinction between the two is that while BT is a single target ability, WW scales off the number of opponents that are hit with it. Knowing that, we can calculate the DPR of both abilities at varying number of targets when wielding different types of weapons. In order to that, we assume the following:


```{r include=FALSE}
scenario1_tbl <- tibble::tribble(
            ~`Weapon`,      ~`Normalized Speed`,   ~`Average Damage`, ~`Attack Power`,
                     "Two Handed Weapon",   3.3, 258, 1750,
        "One Handed Weapon",   2.4,  143, 1750,
        "Dagger", 1.5,    105, 1750
        )

scenario1 <- scenario1_tbl %>%
        clean_names()

```


```{r}
knitr::kable(scenario1_tbl, booktabs = TRUE,
             caption = "Variables affecting Whirlwind damage calculations.")
```

With this, we can calculate the DPR of one use of Whirlwind when hitting a varying number of targets, and compare it to the DPR of Bloodthirst at the same attack power threshold:

```{r include=FALSE}

ap_vals <- seq(0, 2500, by = 250)
btdmg <- sapply(ap_vals, bt)
n1_sword <- sapply(ap_vals, ww, wpn_spd = 2.4, wpn_swing_dmg = 143)

sword_comparison <- as_tibble(cbind(ap_vals, btdmg, n1_sword)) %>%
        rename(n1 = n1_sword) %>%
        mutate(n2 = n1 * 2,
               n3 = n1 * 3,
               n4 = n1 * 4) %>%
        # mutate(bt_dpr = btdmg/30,
        #        n1_)
        pivot_longer(-ap_vals, names_to = "source") %>%
        rename(damage = value)


n1_twohander <- sapply(ap_vals, ww, wpn_spd = 3.3, wpn_swing_dmg = 258)

twohander_comparison <- as_tibble(cbind(ap_vals, btdmg, n1_twohander)) %>%
        rename(n1 = n1_twohander) %>%
        mutate(n2 = n1 * 2,
               n3 = n1 * 3,
               n4 = n1 * 4) %>%
        pivot_longer(-ap_vals, names_to = "source") %>%
        rename(damage = value)


n1_dagger <- sapply(ap_vals, ww, wpn_spd = 1.5, wpn_swing_dmg = 105)

dagger_comparison <- as_tibble(cbind(ap_vals, btdmg, n1_dagger)) %>%
        rename(n1 = n1_dagger) %>%
        mutate(n2 = n1 * 2,
               n3 = n1 * 3,
               n4 = n1 * 4) %>%
        pivot_longer(-ap_vals, names_to = "source") %>%
        rename(damage = value)



```

```{r include=FALSE}

ap_vals <- seq(0, 2500, by = 250)
btdmg <- sapply(ap_vals, bt)

n1_sword <- sapply(ap_vals, ww, wpn_spd = 2.4, wpn_swing_dmg = 143)

sword_comparison_dpr <- as_tibble(cbind(ap_vals, btdmg, n1_sword)) %>%
        rename(n1 = n1_sword) %>%
        mutate(n2 = (n1 * 2)/30,
               n3 = (n1 * 3)/30,
               n4 = (n1 * 4)/30,
               n1 = n1/30,
               btdmg = btdmg/30) %>%
        pivot_longer(-ap_vals, names_to = "source") %>%
        rename(dpr = value)

sword_comparison_dpr <- as_tibble(cbind(ap_vals, btdmg, n1_sword)) %>%
        rename(n1 = n1_sword) %>%
        mutate(n2 = (n1 * 2)/30,
               n3 = (n1 * 3)/30,
               n4 = (n1 * 4)/30,
               n1 = n1/30,
               btdmg = btdmg/30) %>%
        pivot_longer(-ap_vals, names_to = "source") %>%
        rename(dpr = value)


n1_twohander <- sapply(ap_vals, ww, wpn_spd = 3.3, wpn_swing_dmg = 258)

twohander_comparison_dpr <- as_tibble(cbind(ap_vals, btdmg, n1_twohander)) %>%
        rename(n1 = n1_twohander) %>%
        mutate(n2 = (n1 * 2)/30,
               n3 = (n1 * 3)/30,
               n4 = (n1 * 4)/30,
               n1 = n1/30,
               btdmg = btdmg/30) %>%
        pivot_longer(-ap_vals, names_to = "source") %>%
        rename(dpr = value)


n1_dagger <- sapply(ap_vals, ww, wpn_spd = 1.5, wpn_swing_dmg = 105)

dagger_comparison_dpr <- as_tibble(cbind(ap_vals, btdmg, n1_dagger)) %>%
        rename(n1 = n1_dagger) %>%
       mutate(n2 = (n1 * 2)/30,
               n3 = (n1 * 3)/30,
               n4 = (n1 * 4)/30,
               n1 = n1/30,
               btdmg = btdmg/30) %>%
        pivot_longer(-ap_vals, names_to = "source") %>%
        rename(dpr = value)

```

```{r}
# sword_swings <- rnorm(1000, mean = 143, sd = 3)
# twohander_swings <- rnorm(10000, mean = 258, sd = 3)
# dagger_swings <- rnorm(10000, mean = 105, sd = 3)
# 
# ap_vals <- seq(0, 2500, by = 250)
# 
# sword_test <- as_tibble(sapply(ap_vals, ww, wpn_spd = 2.4, wpn_swing_dmg = sword_swings)) %>%
#         rename(`0` = V1,
#                `250` = V2,
#                `500` = V3,
#                `750` = V4,
#                `1000` = V5,
#                `1250` = V6,
#                `1500` = V7,
#                `1750` = V8,
#                `2000` = V9,
#                `2250` = V10,
#                `2500` = V11) %>%
#         pivot_longer(cols = `0`:`2500`, names_to = "ap") %>%
#         rename(damage = value) %>%
#         mutate(ap = as.factor(ap))
# 
# sword_test %>%
#         ggplot(aes(x = ap, y = damage)) +
#         geom_line()
# # sword_test <- tibble::tribble(
# #             ~`ap0`,      ~`ap250`,   ~`ap500`, ~`ap750`, ~`ap1000`, ~`ap1250`, ~`ap1500`, ~`ap1750`, ~`ap2000`, ~`ap2250`, ~`ap2500`)
# #         
# # sword_test <- sword_test %>%
# #         mutate(ap0 = sword_swings)
# 
#         # pivot_longer(cols = ap0:ap2500, names_to = "group")
# 
# btdmg <- as_tibble(sapply(ap_vals, bt)) %>%
#         rename(damage = value)
# 
# sword_test <- sword_test %>%
#         cbind(btdmg)
# 
# ggplot(sword_test, aes(x = ap_vals, colour = group)) + 
#         geom_density_ridges()
#         # geom_point() +
#         # geom_line() +
#         # scale_colour_manual(values = cbp2,
#         #         name = "Damage source",
#         #         labels = c("Bloodthirst", "n = 1", "n = 2", "n = 3", "n = 4")) +
#         #         scale_y_continuous(breaks = seq(0, 120, by = 15),
#         #                            limits = c(0, 120)) + 
#         # labs(x = "Attack Power",
#         #      y = "Damage per Rage",
#         #      title = "Whirlwind has higher DPR than BT at n = 3 or more.",
#         #      subtitle = "Assuming a one hander with 143 mean swing damage and 2.4 weapon speed.")
# 

```

```{r echo=FALSE, fig.cap="Comparison of the damage per rage efficiency between Bloodthirst and Whirlwind with a generic two handed weapon."}

ggplot(twohander_comparison_dpr, aes(x = ap_vals, y = dpr, colour = source)) + 
        geom_point() +
        geom_line() +
        scale_colour_manual(values = cbp2,
                name = "Damage source",
                labels = c("Bloodthirst", "n = 1", "n = 2", "n = 3", "n = 4")) +
        scale_y_continuous(breaks = seq(0, 120, by = 15),
                                   limits = c(0, 120)) +
        labs(x = "Attack Power",
             y = "Damage per Rage",
             title = "Whirlwind has higher DPR than Bloodthirst at n = 2 or more.",
             subtitle = "Assuming a two hander with 258 mean swing damage and 3.3 weapon speed.") +
        theme_light()
```


```{r echo=FALSE, fig.cap="Comparison of the damage per rage efficiency between Bloodthirst and Whirlwind with a generic one handed sword."}
ggplot(sword_comparison_dpr, aes(x = ap_vals, y = dpr, colour = source)) +
        geom_point() +
        geom_line() +
        scale_colour_manual(values = cbp2,
                name = "Damage source",
                labels = c("Bloodthirst", "n = 1", "n = 2", "n = 3", "n = 4")) +
                scale_y_continuous(breaks = seq(0, 120, by = 15),
                                   limits = c(0, 120)) +
        labs(x = "Attack Power",
             y = "Damage per Rage",
             title = "Whirlwind has higher DPR than Bloodthirst at n = 3 or more.",
             subtitle = "Assuming a one hander with 143 mean swing damage and 2.4 weapon speed.") + 
        theme_light()
```

```{r echo=FALSE, fig.cap="Comparison of the damage per rage efficiency between Bloodthirst and Whirlwind with a generic dagger."}
ggplot(dagger_comparison_dpr, aes(x = ap_vals, y = dpr, colour = source)) + 
        geom_point() +
        geom_line() +
        scale_colour_manual(values = cbp2,
                name = "Damage source",
                labels = c("Bloodthirst", "n = 1", "n = 2", "n = 3", "n = 4")) +
                scale_y_continuous(breaks = seq(0, 120, by = 15),
                                   limits = c(0, 120)) +
        labs(x = "Attack Power",
             y = "Damage per Rage",
             title = "Whirlwind has higher DPR than Bloodthirst at n = 4 or more.",
             subtitle = "Assuming a dagger with 105 mean swing damage and 1.5 weapon speed.") + 
        theme_light()
```

The graphs above paint a clear picture: Whirlwind damage per rage increases linearly with number of targets being hit, and that together with the weapon type currently being wielded by the player, should inform *when* the skill should take priority over Bloodthirst at variable attack power thresholds.

## Execute{#execute}

Different from Whirlwind and Bloodthirst, Execute is an ability with no cooldown, variable rage cost, and that can only be activated when the enemy is at 20% HP or lower. Each additional point of rage used in the activation of the ability past it's activation cost adds 15 damage to the total damage dealt by the ability, and points into the Improved Execute talent decrease the activation cost of the ability at 5 rage per talent point. Therefore, we can calculate its damage as:

```{r Execute Damage Formula, message=FALSE, warning=FALSE, include=FALSE}

execute <- function(rage, points = c(0, 1, 2)){
        if(points == 0){
                added = rage-20
        } else if (points == 1){
                added = rage-15
        } else if (points == 2){
                added = rage-10
        }
        damage = 600 + (added*15)
        return(damage)
}

```


\begin{equation}
Execute_{dmg}\ =\ 600\ +\ \left(\left(R-Ac\right)\ \times\ 15\right)
(\#eq:execute_dmg)
\end{equation}

Where $R$ is the player's current rage, $Ac$ is the activation cost of the ability (dictated by how many points the player has in improved execute) and 15 is the damage multiplier per point of rage. Knowing this, we can quickly visualize the damage per rage of the ability at 0, 1, and 2 points into the Improved Execute talent:

```{r include=FALSE}
# rage <- seq(0, 100, by = 1)
# execute_dmg0 <- as_tibble(sapply(rage, execute, ac = 20)) %>%
#         rename(damage0 = value) %>%
#         mutate(rage0 = seq(20, 100, length.out = 101)) %>%
#         mutate(dpr0 = damage0/rage0)
# 
# execute_dmg1 <- as_tibble(sapply(rage, execute, ac = 15)) %>%
#         rename(damage1 = value) %>%
#         mutate(rage1 = seq(15, 100, length.out = 101)) %>%
#         mutate(dpr1 = damage1/rage1)
# execute_dmg2 <- as_tibble(sapply(rage, execute, ac = 10)) %>%
#         rename(damage2 = value) %>%
#         mutate(rage2 = seq(10, 100, length.out = 101)) %>%
#         mutate(dpr2 = damage2/rage2)
# 
# exec_comparison <- bind_cols(execute_dmg0, execute_dmg1, execute_dmg2)

```



1. Intro to Execute (CD, usage, formula, % of overall damage)
2. Execute batching
3. Execute damage per rage

### Execute Switch{#execswitch}

1. Why it was effective on private servers
2. Why it's not effective in Classic
        a. Batching
        b. Execute phase duration
        
## Heroic Strike and Cleave{#heroic}

1. Introduction (formula)
2. Opportunity cost - why damage per ratio is deceptive
3. HS doesn't consume flurry

### HS Queuing#{hsq}

1. Explanation (include macro)
2. Consequences
3. When should you queue?

## Slam{#slam}

1. Intro to Slam
2. How spell batching affects Slam
3. Viability of Slam

## Hamstring{#hamstring}

1. Intro to Hamstring
2. Why use Hamstring?

## Overpower{#overpower}

1. Intro to Overpower
2. Should you use OP? If so, when?

## Battle Shout{#battleshout}

1. Intro to battle shout
2. How much does battle shout add, on average, to our abilities
3. Improved battle shout, how good is it?

## Damage per Rage{#dpr}

1. Damage per Rage comparison between main rotational abilities (BT, WW, Exec)
2. Execute DPR decreases the more rage you have
3. The impact of scaling on DPR, and how that affects your rotation

## The Warrior Priority System

1. The Warrior Priority System