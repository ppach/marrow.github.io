--- 
title: "Marrow's Compendium of Dragonslaying"
author: "Marrow <Nexus>, Heartseeker-US"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
documentclass: book
bibliography: [book.bib, packages.bib]
biblio-style: apalike
link-citations: yes
description: "This is a Fury Warrior Guide for World of Warcraft Classic."
---

# Preamble


This is a guide on how to play a Fury Warrior in World of Warcraft Classic. It is a work in progress and a living document. All of the information contained within reflects what is best understood as of *today*, and some of is subject to change as more about the game is discovered.

More importantly, this is a guide for players who want to push the envelope of their class, and be the best they can be. That is not the playstyle of every player, nor am I advocating it should be. Ultimately, you should pick your race and spec so that they're both what you *enjoy* the most. To some people that is exactly what they'll find in this guide: doing all you can do to maximize your DPS and compete with your friends, or to clear the content as fast and efficiently as possible. To some other people, it might mean playing a Night Elf and raiding as Arms - and that's completely fine. Ultimately, both groups of players will find a guild and a community that fits them and enjoy this amazing game we love so much together.

<!--chapter:end:index.Rmd-->

# Introduction {#intro}

## What is the aim of this guide?

This guide aims to help the reader from the ground up: from the foundational mechanics of World of Warcraft (WoW) combat, to an in-depth overview of warrior abilities and their utilization, to cooldown management, raid consumables, and finally how to analyze parses and learn from your own mistakes.

## What is NOT the aim of this guide

DPS simulations will not be covered. There are several reasons for this, but the most important being that there are incredible, well maintained resources currently available for that exact purpose. Notable mentions include Steppenwolf's Classic Warrior Spreadsheet [@steppen2019], Aurana's Classic Warrior Fury DPS Simulator [@aurana2019], Rafael Pimpa's Furysim [@pimpa_2019] and Guybrush's WarriorSim [@guybrush_2019].

In the same vein, questions on how to (specifically) gear will not be covered in this guide. This is because gearing is *highly* contextual - answering questions such as "What is better, Black Dragonscale 3set or Devilsaur Set with Truestrike Shoulders?" is impossible without knowing the rest of your gear and race. Therefore, when this guide makes recommendations, please be aware that exceptions *do exist*, but are rare. By the end, I hope the reader is knowledgeable enough about the base mechanics to critically assess and reason any gearing questions that he or she may have. 

<!--chapter:end:01-introduction.Rmd-->

# Mechanics{#mechanics}

```{r include=FALSE}
options(scipen = 999)
library(ggplot2)
library(ggpubr)
library(ggthemes)
library(tidyverse)
library(janitor)
library(ggsci)
library(RColorBrewer)
library(cowplot)

# The palette with grey:
cbp1 <- c("#999999", "#E69F00", "#56B4E9", "#009E73",
          "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

# The palette with black:
cbp2 <- c("#000000", "#E69F00", "#56B4E9", "#009E73",
          "#F0E442", "#0072B2", "#D55E00", "#CC79A7")


wepskill_tbl <- tibble::tribble(
        ~Delta, ~"Glancing Penalty", ~"Miss Probability", ~"Hit Cap",
                     15,    0.35,       0.08,   0.09,
                     14,             0.31,       0.078,   0.088,
                     13,   0.27,       0.076,   0.086,
                     12,   0.23,       0.074,   0.084,
                     11,             0.19,       0.072,   0.082,
                     10,   0.15,       0.06,   0.06,
                      9,             0.11,       0.059,   0.059,
                      8,              0.07,       0.058,   0.058,
                      7,     0.05,       0.057,   0.057,
                      6,              0.05,       0.056,   0.056,
                      5,     0.05,       0.055,   0.055,
                      4,              0.05,       0.054,   0.054,
                      3,              0.05,       0.053,   0.053,
                      2,              0.05,       0.052,   0.052,
                      1,              0.05,       0.051,   0.051,
                      0,              0.05,       0.05,   0.05
        ) %>%
        mutate(`Weapon Skill` = seq(300, 315, by = 1),
               `% damage dealt by glancing blow` = 1-`Glancing Penalty`,
               `Glancing Blow Damage Increase` = signif(x = ((`% damage dealt by glancing blow` / 0.65)-1), digits = 2)) %>%
        select(`Weapon Skill`, `% damage dealt by glancing blow`, `Glancing Blow Damage Increase`, everything(), -c(Delta, `Glancing Penalty`))
        
wepskill_code <- wepskill_tbl %>%
        clean_names()

inherit_miss <- wepskill_code %>%
        select(weapon_skill, everything(), -c(`percent_damage_dealt_by_glancing_blow`, glancing_blow_damage_increase)) %>%
        pivot_longer(-weapon_skill, names_to = "type") %>%
        mutate(value = value * 100)
```

## Introduction{#mechanics_intro}

Combat mechanics are at the core of the warrior class, and deeply impact our talent and gearing choices and combat rotation. Therefore, it is important to build a solid foundational understanding of these mechanics in order to make the correct decisions and *understand* the theory behind our choices moving forward.

There are two types of melee attacks: white (auto attacks) and yellow (special attacks). Yellow attacks function exactly like white attacks, except they *cannot* glance. Each white attack made by players against enemy mobs will result in one of the following:

* Miss
* Dodge
* Parry
* Glancing blow
* Block
* Critical Strike
* Hit

A mob being attacked from behind *cannot* block or parry, and thus these two outcomes are removed from the roll table. This means our white attacks can only either miss, be dodged, glance, hit, or critically hit. Therefore, in order to maximize our damage we need to minimize $P(Miss)$ and $P(Dodge)$, maximize $P(Crit)$, and increase the damage done by glancing blows, seeing as how $P(Glance)$ is fixed at $.4$. In the subsequent sections, we will take a deeper look into how we can achieve that.


## Miss Chance, Glancing Blows, and Weapon Skill{#miss_glancing_weapon}

### Miss Chance{#miss_chance}

Blizzard has confirmed that players have an 8% chance ^[Note that, due to the inherent hit suppression against level 63 mobs, the hit cap and the $P(Miss)$ are different until 305 weapon skill. This behavior is further explained in \@ref(weapon_skill) to miss a creature that is 3 levels above them [@blizz_atktbl2019]. Empirical work from magey and others [@magey_atktbl2019] further corroborates a formula originally proposed by Beaza during vanilla [@beaza_miss2006], which can be summarized as:

If the target is a mob and the difference between its defense rating and the attacker's weapon skill is 11 or more:

\begin{equation}
P\left(Miss\right)\ =\ 5\ +\ \left(\left(T_{lvl}\times 5\right)-Atk_{skill}\right)\times 0.2
(\#eq:missprob1)
\end{equation}

If the target is a mob and the difference between its defense rating and the attacker's weapon skill is 10 or less:

\begin{equation}
P\left(Miss\right)\ =\ 5\ +\ \left(\left(T_{lvl}\times 5\right)-Atk_{skill}\right)\times 0.1
(\#eq:missprob2)
\end{equation}

Where $T_{lvl}$ is the target's level, and $Atk_{skill}$ is the attacker's weapon skill rating. While simple, this formula carries immense significance - it means that that by having 305 weapon skill, a player only has a 6% chance to miss an enemy mob 3 levels higher, which includes raid bosses. Conversely, a player with only 300 weapon skill will have an 8% chance to miss. This is a huge difference, especially in conjunction with the other benefits that weapon skill brings. It is important to note, however, that this is the behavior exhibited by wielding one weapon. If dual wielding, the probability of missing an attack is calculated as:

\begin{equation}
P\left(DW_{miss}\right)\ =\ \left(P\left(Miss\right)\ \times\ 0.8\right)\ +\ 0.2
(\#eq:dwmissprob)
\end{equation}

As a disclaimer, magey notes that further testing is still required to assert the correctness of this formula.

### Glancing Blows{#glancing_blows}

Glancing blows are a type of attack that can only occur when fighting an enemy of equal or higher level, and are restricted to white attacks. In accordance with Beaza, magey et al. have determined the glancing blow probability to be as follows:


\begin{equation}
P\left(Glancing\right)\ =\ 0.1\ +\ \left(T_{lvl}\times5\ -\ \min\left(Atk_{lvl}\times 5,\ Atk_{skill}\right)\right)\times 0.02
(\#eq:glancingprob)
\end{equation}


Where $Atk_{lvl}$ is the player's level, and $Atk_{skill}$ is the player's weapon skill value. Knowing that, we can compute the probability that our white attacks will glance, and the damage penalty that that glancing blow carries against enemies of different levels:

```{r glancing_tbl_calc, include=FALSE}
glancing_tbl <- tibble::tribble(
        ~"Level Difference", ~"Probability", ~"Damage Penalty",
              0,            0.1,                 0.05,
              1,            0.2,                 0.05,
              2,            0.3,                0.15,
              3,            0.4,                0.35
        )
```

```{r echo=FALSE}

knitr::kable(
        glancing_tbl,
        booktabs = TRUE,
             caption = "Glancing blow probability and damage penalty per level difference."
        )
```

This means that against a level 63 enemy mob (all raid bosses) and with 300 weapon skill our white attacks have a 40% chance of being glancing blows, therefore only being capable of dealing 65% of their maximum damage. Needless to say this is an immense DPS loss and should be mitigated as much as possible, and the *only* way that can be done is through increasing the player's weapon skill.

### Weapon Skill{#weapon_skill}

magey's work again corroborates the impact of weapon skill on glancing blow probability, damage, and miss probability according to Beaza's formulas (\@ref(eq:glancingprob), \@ref(eq:missprob1)  and \@ref(eq:missprob2)). The table below summarizes that impact, but it is important to note that not all values have been experimentally confirmed due to the difficulty in acquiring specific weapon skill values that inherently comes from WoW itemization.

```{r echo=FALSE}

knitr::kable(wepskill_tbl,
             booktabs = TRUE,
             caption = "Weapon skill impact on glancing blow damage reduction, miss chance, and hit cap. Damage increase is relative to 300 weapon skill.")
```

As we can see, weapon skill not only reduces the glancing blow damage penalty, it also reduces the hit cap and the $P(Miss)$.


The glancing blow damage penalty reduction is more easily shown graphically:

```{r echo=FALSE, fig.cap = "Weapon skill greatly reduces the glancing blow damage penalty"}
wepskillplot1 <- ggplot(wepskill_code, aes(x = weapon_skill, y = `percent_damage_dealt_by_glancing_blow`)) +
        geom_line() +
        geom_point() +
        labs(x = "Weapon Skill", 
             y = "Glancing blow damage as percent of white attack",
             title = "Weapon skill greatly reduces the glancing blow damage penalty") +
        scale_x_continuous(breaks = c(300:315)) +
        scale_y_continuous(breaks = c(0.7, 0.75, 0.8, 0.85, 0.9, 0.95, 1)) +
        theme_light()
wepskillplot1
```

```{r echo=FALSE, fig.cap = "Weapon skill increases damage on glancing, relative to 300 weapon skill."}
ggplot(wepskill_code, aes(x = weapon_skill, y = glancing_blow_damage_increase)) +
        geom_line() +
        geom_point() +
        labs(x = "Weapon Skill",
             y = "Damage increase percentage",
             title = "Glancing blow damage increase is linear until 307 weapon skill",
             subtitle = "Relative to 300 weapon skill") +
        scale_x_continuous(breaks = c(300:315)) +
        theme_light()
```


As we can see, our glancing blows increase in damage linearly with weapon skill until 307 weapon skill. This is incredibly important, as it indicates 308 weapon skill to being the soft cap for glancing blow damage penalty reduction - meaning the player gains no benefits in this aspect if their weapon skill is higher than 308 when facing a raid boss.

Similarly, the impact of weapon skill on the $P(Miss)$ and hit cap is clearer when shown graphically:

```{r echo=FALSE, fig.cap = "Weapon skill contributes to overcome the 1% hit suppression and the miss probability, but suffers steep diminishing returns after 305."}
inherit_miss %>%
        ggplot(aes(x = weapon_skill, y = value, colour = type)) +
        geom_line() +
        geom_point() +
        labs(x = "Weapon Skill",
             y = "Percent",
             title = "305 weapon skill overcomes the inherent 1% hit suppression") +
        scale_colour_manual(values = cbp2,
                name = "Type",
                labels = c("Hit Cap", "Miss Probability")) +
        theme_light()

        
```

As we can see, the player's hit cap starts 1% higher than $P(Miss)$ at 300 weapon skill. This is because vanilla WoW code explicitly suppresses the  **first 1%** of +hit gained from talents or gear against enemy mobs with more than 10 defense skill above the player's weapon skill [@blizz_hitcap2019], in accordance with \@ref(eq:missprob1). This hit suppression is **not** applied, however, if the difference between the attacker's weapon skill and the enemy mob's defense skill is less than 10 \@ref(eq:missprob2). Note that values past 305 weapon skill suffer from steep diminishing returns, where an increase of 10 points past that only translates to a hit cap decrease of 1%.

This is why weapon skill is so important: not only does it reduce the glancing blow damage penalty, it removes the inherit 1% hit suppresion, and significantly reduces $P(Miss)$ until 305. This is also why a weapon skill of at least 305 and at most 308 is **highly** recommended. The first 5 points are crucial to overcome the 1% hit deficit, and the 8 points enables us to reach the maximum glancing blow damage. This is a complicated threshold to reach, however, as there are very few items in World of Warcraft that add small amounts of Weapon Skill that would enable you to get to 308. Furthermore, the fact that weapon skill's value in respect to hit chance is *vastly* diminished after 305 clearly indicates that 305 weapon skill is the **most** optimal weapon skill value for Fury Warriors in Classic WoW. 

This is why any weapon skill bonus of over 5, whether given by a racial (orcs with axes, humans with maces and swords) or an item is so good - it means that single piece of gear is enough to overcome the hit suppresion versus raid bosses, as well as reducing your $P(Miss)$ by 2%, and glancing blow damage penalty reduction. This is a massive advantage, especially compared to the alternative which is gearing for weapon skill through items such as [Edgemaster's Handguards](https://classic.wowhead.com/item=14551/edgemasters-handguards), since the player with the built in weapon skill essentially has one extra item slot over a non-human, non-orc player. This is also why items that give good stats *in addition* to weapon skill, such as [Aged Core Leather Gloves](https://classic.wowhead.com/item=18823/aged-core-leather-gloves) (ACLG), are incredibly good.

## The Crit Cap{#crit_cap}

Due to the nature of the two-roll system in World of Warcraft combat, attacks past a certain $P(Crit)$ dictate every non-glancing auto attack will result in a critical strike. This threshold is also known as the **crit cap**, and decreasing $P(Miss)$ and $P(Dodge)$ through an increase in Weapon Skill or increasing $P(Hit)$ will increase it. Since we cannot decrease $P(Glance)$, we can calculate the crit cap as:

\begin{equation}
\small Crit_{cap}\ =\ 100-P\left(Miss\right)-P\left(Dodge\right)-P\left(Block\right)-P\left(Parry\right)-P\left(Glance\right)+Crit_{\sup}
(\#eq:critcap)
\end{equation}

Where $Crit_{sup}$ is the innate crit suppresion against a level 63 mob [@magey_atktbl2019]. As the player's gear level increases through phases, so does their $P(Crit)$ - which when taken into account with world buffs makes reaching the crit cap a real possibility, regardless of the interaction it may have with HS queueing \ref(hsq). This is because even when simulating fights with perfect HS queueing/unqueueing a very large proportion of main hand swings are still white, and as such result the relative value of hit increases throughout phases. 


## Flurry{#flurry}

Flurry is a 5 point talent that, when maxed, increases the warrior's attack speed by 30% for the next 3 swings after dealing a critical strike. This represents a very significant damage increase, and as such warrior itemization values crit very highly in order to obtain higher and higher flurry uptimes, which can be calculated as follows: 

\begin{equation}
F_{up}\ =\ 1\ -\ \left(\left(1-P\left(Crit\right)\right)^A\right)
(\#eq:flurryuptime)
\end{equation}


```{r Flurry Formula, message=FALSE, warning=FALSE, include=FALSE}
flurry <- function(crit, attks){
        uptime = 1 - (( 1 - crit ) ^ attks)
        return(uptime)
}
```

Where $F_{up}$ is the uptime, $P(Crit)$ is the player's crit chance, and $A$ is the number of attacks made in one cycle of Flurry (3 from auto attack swings, and generally one additional from an instant attack; 4 is a reasonable number for a dual wielding player). Flurry is often misunderstood - the main misconception being that 33% crit will translate to 100% flurry uptime. This is incorrect, as shown by the following graph: 

```{r echo=FALSE, fig.cap = "Increase in critical strike chance increases flurry uptime."}
dat <- as.data.frame(seq(0, 1, .01))
flurry_uptime <- as.data.frame(lapply(dat, flurry, attks = 4))
test <- cbind(dat, flurry_uptime)

ggplot(test, aes(x = test$`seq(0, 1, 0.01)`, y = test$seq.0..1..0.01.)) +
        geom_line() +
        labs(x = "Crit chance", 
             y = "Flurry uptime",
             title = "Crit chance impact on flurry uptime",
             subtitle = "With A = 4") +
        scale_x_continuous(breaks = seq(0, 1, .1)) +
        scale_y_continuous(breaks = seq(0, 1, .2)) +
        theme_light()
```

We can we now see that a $P(Crit) = .33$ only actually results in roughly 80% Flurry uptime. In fact, any amount of crit under 100% (or the crit cap) will result in less than 100% Flurry uptime, with increasing amounts of crit becoming less valuable the higher your $P(Crit)$ is. This is to say that the amount of Flurry uptime gained going for 1% crit to 11% crit is much greater than going from 40% to 50%, despite both cases representing a 10% overall $P(Crit)$ increase. 


<!--chapter:end:02-mechanics.Rmd-->


```{r include=FALSE}

library(janitor)
library(tidyverse)
library(ggplot2)
library(ggridges)
library(gghighlight)
theme_set(theme_light())

# The palette with grey:
cbp1 <- c("#999999", "#E69F00", "#56B4E9", "#009E73",
          "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

# The palette with black:
cbp2 <- c("#000000", "#E69F00", "#56B4E9", "#009E73",
          "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

ad_dmg <- function(ap, wpn_spd){
        added_dmg = ap * (wpn_spd/14)
        return(added_dmg)
}

bt <- function(ap, crit = 0.3, dodge = 0.06){
        multiplier = 1+crit-dodge
        damage = multiplier * (ap * 0.45)
        return(damage)
}

# execute <- function(rage, crit = 0.3, dodge = 0.06){
#         damage = multiplier * (600 + ((rage-10)*15))
#         return(damage)
# }

ap_vals <- seq(0, 2500, by = 250)

execute <- function(rage, points = 2, crit = 0.3, dodge = 0.06, multiplier = TRUE){
        
        if(points == 0){
                added = rage-15
        } else if (points == 1){
                added = rage-13
        } else if (points == 2){
                added = rage-10
        }
        
        if(multiplier == TRUE){
                
                multiplier = 1+crit-dodge
                damage = (600 + (added*15)) * multiplier
                
        } else if (multiplier == FALSE){
                
                damage = (600 + (added*15))
        }
        return(damage)
}


ww <- function(wpn_swing_dmg, wpn_spd, ap, crit = 0.3, dodge = 0.06){
        multiplier = 1+crit-dodge
        additional = ad_dmg(ap, wpn_spd)
        total = wpn_swing_dmg + (additional)
        damage = multiplier * total
        return(damage)
}

slam <- function(wpn_swing_dmg, wpn_spd = 3.3, ap, crit = 0.3, dodge = 0.06){
        additional = (ad_dmg(ap, wpn_spd)) + 87
        total = wpn_swing_dmg + (additional)
        multiplier = 1+crit-dodge
        damage = multiplier * total
        return(damage)
}

conversion_values_tbl <- tibble::tribble(
        ~`Player Level`,    ~`Conversion Value`,
                   10,  37.4,
                   20,  72.4,
                   30, 109.3,
                   40, 147.9,
                   50, 188.3,
                   60, 230.6
        )

hit_factor_tbl <- tibble::tribble(
            ~`Weapon`,      ~`Hit Type`,   ~`Hit factor`,
        "Main Hand",   "Normal Hit",  3.5,
        "Main Hand", "Critical Hit",    7,
         "Off Hand",   "Normal Hit", 1.75,
         "Off Hand", "Critical Hit",  3.5
        )

ap_thresh <- as.data.frame(seq(0, 3000, 100))
bt_dmg <- as.data.frame(lapply(ap_thresh, bt))
bt_dmg <- bind_cols(ap_thresh, bt_dmg)
bt_dmg <- bt_dmg %>%
        unnest() %>%
        transmute(AP = `seq(0, 3000, 100)`,
                  Damage = `seq.0..3000..100.`) %>%
        mutate(dpr = Damage/30)

# bt_dmg_exec <- as_tibble(cbind(ap_vals, btdmg)) %>%
#         rename(damage = btdmg) %>%
#         mutate(source = "bloodthirst") %>%
#         mutate(dpr = damage/30)
btdmg <- sapply(ap_vals, bt)
btdmg_slam <- as_tibble(cbind(ap_vals, btdmg)) %>%
        rename(damage = btdmg) %>%
        mutate(source = "bloodthirst") %>%
        mutate(dpr = damage/30)

```


# Abilities and Rotation{#abilities}

A warrior's resource is the finite, yet continuously generated, rage. Rage is capped at 100, and the Vanilla WoW Wiki [@vanillawiki_2019] tells us rage is generated by a successful white attack according to the following formula:

\begin{equation}
Rage_{gen}\ =\ \left(\frac{D}{C}\right)\ \times\ 15
(\#eq:ragegen)
\end{equation}

```{r include=FALSE}
rage_gen <- function(D){
        rage_gen <- ((D/230.6) * 15)
        return(rage_gen)
}
```

Where $D$ is the damage dealt, and $C$ is the rage conversion value. The rage conversion value varies by player character level and is dependent on other values such as the mob's hit points and the warrior's expected damage value against that mob. It can be calculated by the following formula:

\begin{equation}
C\ =\ \left(0.0091107836\ \times\ Lvl^2\right)\ +\ \left(3.225598133\ \times\ Lvl\right)\ +\ 4.2652911
(\#eq:convvalue)
\end{equation}

What this tells us is that very low damage attacks have an upper bound on how much they can be averaged up by the hit factor of the. Knowing this, we can calculate the conversion value for various level ranges:

```{r echo=FALSE}
knitr::kable(conversion_values_tbl, booktabs = TRUE,
             caption = "Rage conversion values.")
```


In any given fight, we will only generate a finite amount of rage. This means that to deal as much damage as we can, in the most efficient way possible, we need to maximize the ratio between damage dealt and rage spent - the **damage per rage** (DPR). This can easily be calculated:

\begin{equation}
DPR\ =\ \frac{Damage}{Rage}
(\#eq:dprformula)
\end{equation}

Although this is an easy concept to grasp, it'll be an essential part of our discussions throughout this chapter from now on. This is because the DPR of our abilities is **not** constant - Whirlwind's (WW) DPR varies depending on the number of enemies around and the damage and type of our weapon, Execute's varies based on how much rage we consume when activating the ability, and Bloodthirst's depends on our current attack power. Doing as much damage as possible in a fight, thus, is about calculating the DPR of each one of these abilities as the encounter progresses, and utilizing the one with the maximum DPR. We will revisit this concept in more depth in \@ref(dpr).

Note: For all of the following damage and DPR calculations, we will assume $P(Crit) = 0.3$, $P(Dodge) = 0.06$, and 305 weapon skill. This hidden multiplier will be applied to all subsequent damage and graph calculations.


## Bloodthirst{#bloodthirst}


Bloodthirst (BT) is an instant ability on a 6 second cooldown that costs 30 rage and hits the enemy target for 45% of our attack power (AP). Mathematically, we can represent its damage as:

\begin{equation}
BT_{dmg}\ =\ AP\ \times\ 0.45
(\#eq:btdmg)
\end{equation}

It might not be immediately apparent, but this is one of the main reasons why fury warrior damage scales so well - no other ability in the game benefits from attack power as much as Bloodthirst. As we will soon see, at 30 rage it has the highest damage per rage of any of our abilities against a single target, and as such should be prioritized in most cases. The formula shows a linear increase in damage, which can be displayed graphically:

```{r echo = FALSE, fig.cap="Bloodthirst scales linearly with attack power and is completely independent of weapon damage."}

ggplot(data = bt_dmg, aes(AP, Damage)) +
        geom_line() +
        geom_point() +
        labs(x = "Attack Power",
             y = "Damage",
             title = "Bloodthirst scales linearly with attack power") +
        scale_x_continuous(breaks = seq(0, 3000, 500))+
        scale_y_continuous(breaks = seq(0, 2000, 150))
```

This complete dependence on AP has another important implication: it means Bloodthirst's damage is completely weapon independent. Two warriors utilizing the same gear except for weapons - with one utilizing a 2 handed weapon and the other a dagger - will deal the same damage with Bloodthirst.


## Whirlwind{#whirlwind}

Whirlwind is an area of effect ability (AoE) that hits four enemy mobs with your currently equipped main hand weapon, on a 10 second cooldown. Its damage can be calculated as:

\begin{equation}
WW_{dmg}\ = Wep_{swing}\ +\ \left(AP\ \times\ \left(\frac{Wep_{speed}}{14}\right)\right)
(\#eq:wwdmg)
\end{equation}

Where $Wep_{swing}$ is the damage caused by your weapon swing, and the right term is the damage added to that swing by your AP.

The formula allows us to notice two differences between the damage scaling of Whirlwind when compared to Bloodthirst: while Whirlwind scales with weapon damage, it scales much more poorly with AP. Another important distinction between the two is that while Bloodthirst is a single target ability, Whirlwind scales off the number of opponents that are hit with it. Knowing that, we can calculate the DPR of both abilities at varying number of targets when wielding different types of weapons. In order to that, we assume the following:


```{r include=FALSE}
scenario1_tbl <- tibble::tribble(
            ~`Weapon`,      ~`Normalized Speed`,   ~`Average Damage`, ~`Attack Power`,
                     "Two Handed Weapon",   3.3, 258, 1750,
        "One Handed Weapon",   2.4,  143, 1750,
        "Dagger", 1.5,    105, 1750
        )

scenario1 <- scenario1_tbl %>%
        clean_names()

```


```{r weapons}
knitr::kable(scenario1_tbl, booktabs = TRUE,
             caption = "Variables affecting Whirlwind damage calculations.")
```

Kowing this, we can calculate the DPR of one use of Whirlwind when hitting a varying number of targets, and compare it to the DPR of Bloodthirst at the same attack power threshold:

```{r include=FALSE}

ap_vals <- seq(0, 2500, by = 250)
btdmg <- sapply(ap_vals, bt)
n1_sword <- sapply(ap_vals, ww, wpn_spd = 2.4, wpn_swing_dmg = 143)

sword_comparison <- as_tibble(cbind(ap_vals, btdmg, n1_sword)) %>%
        rename(n1 = n1_sword) %>%
        mutate(n2 = n1 * 2,
               n3 = n1 * 3,
               n4 = n1 * 4) %>%
        # mutate(bt_dpr = btdmg/30,
        #        n1_)
        pivot_longer(-ap_vals, names_to = "source") %>%
        rename(damage = value)


n1_twohander <- sapply(ap_vals, ww, wpn_spd = 3.3, wpn_swing_dmg = 258)

twohander_comparison <- as_tibble(cbind(ap_vals, btdmg, n1_twohander)) %>%
        rename(n1 = n1_twohander) %>%
        mutate(n2 = n1 * 2,
               n3 = n1 * 3,
               n4 = n1 * 4) %>%
        pivot_longer(-ap_vals, names_to = "source") %>%
        rename(damage = value)


n1_dagger <- sapply(ap_vals, ww, wpn_spd = 1.5, wpn_swing_dmg = 105)

dagger_comparison <- as_tibble(cbind(ap_vals, btdmg, n1_dagger)) %>%
        rename(n1 = n1_dagger) %>%
        mutate(n2 = n1 * 2,
               n3 = n1 * 3,
               n4 = n1 * 4) %>%
        pivot_longer(-ap_vals, names_to = "source") %>%
        rename(damage = value)



```

```{r include=FALSE}

ap_vals <- seq(0, 2500, by = 250)
btdmg <- sapply(ap_vals, bt)

n1_sword <- sapply(ap_vals, ww, wpn_spd = 2.4, wpn_swing_dmg = 143)

sword_comparison_dpr <- as_tibble(cbind(ap_vals, btdmg, n1_sword)) %>%
        rename(n1 = n1_sword) %>%
        mutate(n2 = (n1 * 2)/30,
               n3 = (n1 * 3)/30,
               n4 = (n1 * 4)/30,
               n1 = n1/30,
               btdmg = btdmg/30) %>%
        pivot_longer(-ap_vals, names_to = "source") %>%
        rename(dpr = value)

sword_comparison_dpr <- as_tibble(cbind(ap_vals, btdmg, n1_sword)) %>%
        rename(n1 = n1_sword) %>%
        mutate(n2 = (n1 * 2)/30,
               n3 = (n1 * 3)/30,
               n4 = (n1 * 4)/30,
               n1 = n1/30,
               btdmg = btdmg/30) %>%
        pivot_longer(-ap_vals, names_to = "source") %>%
        rename(dpr = value)


n1_twohander <- sapply(ap_vals, ww, wpn_spd = 3.3, wpn_swing_dmg = 258)

twohander_comparison_dpr <- as_tibble(cbind(ap_vals, btdmg, n1_twohander)) %>%
        rename(n1 = n1_twohander) %>%
        mutate(n2 = (n1 * 2)/30,
               n3 = (n1 * 3)/30,
               n4 = (n1 * 4)/30,
               n1 = n1/30,
               btdmg = btdmg/30) %>%
        pivot_longer(-ap_vals, names_to = "source") %>%
        rename(dpr = value)


n1_dagger <- sapply(ap_vals, ww, wpn_spd = 1.5, wpn_swing_dmg = 105)

dagger_comparison_dpr <- as_tibble(cbind(ap_vals, btdmg, n1_dagger)) %>%
        rename(n1 = n1_dagger) %>%
       mutate(n2 = (n1 * 2)/30,
               n3 = (n1 * 3)/30,
               n4 = (n1 * 4)/30,
               n1 = n1/30,
               btdmg = btdmg/30) %>%
        pivot_longer(-ap_vals, names_to = "source") %>%
        rename(dpr = value)

```



```{r echo=FALSE, fig.cap = "Comparison of the damage per rage efficiency between Bloodthirst and Whirlwind with a generic two handed weapon."}

ggplot(twohander_comparison_dpr, aes(x = ap_vals, y = dpr, colour = source)) + 
        geom_point() +
        geom_line() +
        scale_colour_manual(values = cbp2,
                name = "Number of targets",
                labels = c("Bloodthirst", "n = 1", "n = 2", "n = 3", "n = 4")) +
        scale_y_continuous(breaks = seq(0, 140, by = 20),
                                   limits = c(0, 145)) +
        labs(x = "Attack Power",
             y = "Damage per Rage",
             title = "Whirlwind has higher DPR than Bloodthirst at n = 2 or more.",
             subtitle = "Assuming a two hander with 258 mean swing damage and 3.3 weapon speed.") +
        theme_light()
```


```{r echo=FALSE, fig.cap = "Comparison of the damage per rage efficiency between Bloodthirst and Whirlwind with a generic one handed sword."}
ggplot(sword_comparison_dpr, aes(x = ap_vals, y = dpr, colour = source)) +
        geom_point() +
        geom_line() +
        scale_colour_manual(values = cbp2,
                name = "Number of targets",
                labels = c("Bloodthirst", "n = 1", "n = 2", "n = 3", "n = 4")) +
                scale_y_continuous(breaks = seq(0, 140, by = 20),
                                   limits = c(0, 145)) +
        labs(x = "Attack Power",
             y = "Damage per Rage",
             title = "Whirlwind has higher DPR than Bloodthirst at n = 2 or more.",
             subtitle = "Assuming a one hander with 143 mean swing damage and 2.4 weapon speed.") + 
        theme_light()
```

```{r echo=FALSE, fig.cap = "Comparison of the damage per rage efficiency between Bloodthirst and Whirlwind with a generic dagger."}
ggplot(dagger_comparison_dpr, aes(x = ap_vals, y = dpr, colour = source)) + 
        geom_point() +
        geom_line() +
        scale_colour_manual(values = cbp2,
                name = "Number of targets",
                labels = c("Bloodthirst", "n = 1", "n = 2", "n = 3", "n = 4")) +
                scale_y_continuous(breaks = seq(0, 140, by = 20),
                                   limits = c(0, 145)) +
        labs(x = "Attack Power",
             y = "Damage per Rage",
             title = "Whirlwind has higher DPR than Bloodthirst at n = 3 or more.",
             subtitle = "Assuming a dagger with 105 mean swing damage and 1.5 weapon speed.") + 
        theme_light()
```

The graphs above paint a clear picture: Whirlwind damage per rage increases linearly with number of targets being hit, and that together with the weapon type currently being wielded by the player, should inform *when* the skill should take priority over Bloodthirst at variable attack power thresholds.

## Execute{#execute}

Different from Whirlwind and Bloodthirst, Execute is an ability with no cooldown and variable rage cost, which can only be activated when the enemy is at 20% HP or lower. Each additional point of rage used in the activation of the ability past its activation cost adds 15 damage to the total damage dealt by the ability, and points into the Improved Execute talent decrease the activation cost of the ability per talent point. Therefore, we can calculate its damage as:

```{r Execute Damage Formula, message=FALSE, warning=FALSE, include=FALSE}
# 
# execute <- function(rage, points = 2){
#         if(points == 0){
#                 added = rage-15
#         } else if (points == 1){
#                 added = rage-13
#         } else if (points == 2){
#                 added = rage-10
#         }
#         damage = 600 + (added*15)
#         return(damage)
# }

```


\begin{equation}
Execute_{dmg}\ =\ 600\ +\ \left(\left(R-Ac\right)\ \times\ 15\right)
(\#eq:executedmg)
\end{equation}

Where $R$ is the player's current rage, $Ac$ is the activation cost of the ability (dictated by how many points the player has in improved execute) and 15 is the damage multiplier per point of rage. Knowing this, we can quickly visualize the damage per rage efficiency of the ability at 0, 1, and 2 points into the Improved Execute talent:

```{r include=FALSE}
rage <- seq(0, 100, by = 1)

execute_dmg0 <- as_tibble(sapply(rage, execute, points = 0)) %>%
        rename(damage = value) %>%
        mutate(rage = seq(0, 100, by = 1)) %>%
        mutate(dpr = damage/rage) %>%
        mutate(points = "0_points") %>%
        filter(rage > 20)

execute_dmg1 <- as_tibble(sapply(rage, execute, points = 1)) %>%
        rename(damage = value) %>%
        mutate(rage = seq(0, 100, by = 1)) %>%
        mutate(dpr = damage/rage) %>%
        mutate(points = "1_point") %>%
        filter(rage > 15)
execute_dmg2 <- as_tibble(sapply(rage, execute, points = 2)) %>%
        rename(damage = value) %>%
        mutate(rage = seq(0, 100, by = 1)) %>%
        mutate(dpr = damage/rage) %>%
        mutate(points = "2_points") %>%
        filter(rage > 10)


exec_comparison <- bind_rows(execute_dmg0, execute_dmg1, execute_dmg2)
```

```{r echo=FALSE, fig.cap = "Comparison of rage consumed and Execute DPR by different talent point investments into the Improved Execute talent. "}
# ggplot(exec_comparison, aes(x = damage, y = dpr, colour = points)) +
#         geom_line() +
#         # geom_point(aes(size = rage, alpha = 1/100)) +
#                 scale_colour_manual(values = cbp2,
#                 name = "Improved Execute",
#                 labels = c("0 points", "1 point", "2 points")) +
#         labs(x = "Damage",
#              y = "Damage per Rage",
#              title = "Damage per rage and Execute damage are inversely proportional.",
#              subtitle = "Damage per rage efficiency decreases as rage consumed by Execute increases.")

ggplot(exec_comparison, aes(y = dpr, x = rage, colour = points)) +
        geom_line() +
        # geom_point(aes(size = rage, alpha = 1/100)) +
        scale_colour_manual(values = cbp2,
        name = "Improved Execute",
        labels = c("0 points", "1 point", "2 points")) +
        scale_x_continuous(breaks = seq(0, 100, by = 10)) +
        labs(y = "Damage per Rage",
             x = "Rage",
             title = "Low rage Executes are more efficient than high rage executes.",
             subtitle = "DPR and Execute damage are inversely proportional.")
```


The graph enables us to visualize a big difference between Execute and our other abilities. While Bloodthirst and Whirlwind have a fixed rage cost, Execute's rage cost is **variable**. Not only that, since damage dealt is calculated by the addition of the base damage and the amount of rage multiplied, this means that **DPR and damage of Execute are inversely proportional**. Practically speaking, this means that an Execute at 10 rage is much more efficient than an execute at 100 rage, despite the latter dealing more damage.  This is because everytime Execute is activated, we gain "free" damage from the baseline ability, which does not scale with rage - meaning two 15 rage Execute activations will do more damage than one 30 rage Execute. Therefore, the most optimal way to spend rage during the Execute phase is to use it *immediately* at the lowest rage possible - resulting in higher DPR.

### Execute vs Bloodthirst{#execvsbt}

We have now seen how both abilities work, and there is a distinct difference between them - while Execute does not scale (and in fact gets worse the more rage is spent to activate it), Bloodthirst is our best scaling ability. Therefore, it stands to reason that there might exist a point where Bloodthirst outscales Execute, both in terms of DPR and damage. Let's investigate this.

The lowest activation cost possible for Bloodthirst is 30 rage. Therefore, to find out at which point Bloodthirst has higher DPR than Execute, all we need to do is find out: 

1. What the Execute damage at 30 rage is:

$$Execute_{dmg}\ =\ 600\ +\ \left(\left(30-10\right)\ \times\ 15\right)$$
$$Execute_{dmg}\ =\ 900$$

2. What Bloodthirst AP level we require to achieve that damage:

$$\frac{900}{0.45}\ =\ AP\ $$

$$AP\ =\ 2000$$

This means that, if the player has over 2000 AP **and** 30 or more rage, he or she should prioritize Bloodthirst *over* Execute, as it'll result in higher DPR.
```{r}
# bt_dmg <- bt_dmg %>%
#         mutate(source = "Bloodthirst") %>%
#         mutate(ragecost = "30") %>%
#         mutate(ability = source)
# exec_dmg <- tibble(
#         ragecost = seq(10, 100, by = 1),
#         damage = execute(ragecost),
#         dpr = damage/ragecost,
#         ability = "Execute"
# )
# 
# ggplot() +
#         geom_point(data = bt_dmg, aes(x = Damage, y = dpr, color = ability)) +
#         geom_point(data = exec_dmg, aes(x = damage, y = dpr, color = ability)) +
#         gghighlight(damage == 900, label_key = damage, use_direct_label = FALSE) +
#         scale_x_continuous(breaks = seq(0, 2000, by = 200)) +
#         scale_colour_manual(values = cbp2,
#                 name = "Ability",
#                 labels = c("Bloodthirst", "Execute")) +
#         # scale_y_continuous(breaks = seq(40, 55, by = 5)) +
#         labs(y = "Damage per Rage",
#              x = "Damage",
#              title = "bla",
#              subtitle = "bla")
#         
```


### Execute Switch{#execswitch}

As we now understand the relationship between rage spent and Execute DPR, it becomes clear that activating Execute at its rage minimum cost will maximize our DPR. Therefore, it stands to reason that weapons that enable us to Execute more *often* while just going over the ability's activation cost are the best candidates for this. Let's compare our three types of weapons again (\@ref(tab:weapons)), assuming the following:

* The player has 305 weapon skill for all weapon types.
* The player has two points into Improved Execute.
* For the one hander and dagger comparisons, we assume an offhand generating an average of 5 rage per every 1.6 second swing. 


```{r echo=FALSE}

# library(timetk)
# library(tidyquant)
# library(tibbletime)
# library(lubridate)
#Assume 6% hit with 305 weapon skill
        
gcds <- as_tibble(seq(0, 20, by = 1.5))
phase <- as_tibble(seq(0, 20, by = 0.1)) %>%
        rename(time = value)


oh_swing <- as_tibble((seq(0, 20, by = 1.6))) %>%
        mutate(weapon = "offhand") %>%
        rename(time = value) %>%
        mutate(swing_dmg = rnorm(mean = 82, sd = 3, n = 13)) %>%
        mutate(rage = rage_gen(swing_dmg)) %>%
        mutate(hit = 1)

dagger_swing <- as_tibble((seq(0, 20, by = 1.5))) %>%
        mutate(weapon = "dagger") %>%
        rename(time = value) %>%
        mutate(rage = rage_gen(rnorm(mean = 105, sd = 3, n = 14)) + mean(oh_swing$rage)) %>%
        mutate(hit = 1)
        # bind_rows(oh_swing)


sword_swing <- as_tibble((seq(0, 20, by = 2.4))) %>%
        mutate(weapon = "sword") %>%
        rename(time = value) %>%
        mutate(rage = rage_gen(rnorm(mean = 143, sd = 3, n = 9)) + mean(oh_swing$rage)) %>%
        mutate(hit = 1)
        # bind_rows(oh_swing)



twohander_swing <- as_tibble((seq(0, 20, by = 3.3))) %>%
        mutate(weapon = "twohander") %>%
        rename(time = value) %>%
        mutate(rage = rage_gen(rnorm(mean = 258, sd = 3, n = 7))) %>%
        mutate(hit = 1)

fight <- bind_rows(twohander_swing, sword_swing, dagger_swing) %>%
        mutate(damage = execute(rage),
               dpr = damage/rage)

depdpr <- round(fight %>% filter(weapon == "dagger") %>% summarize(sum = sum(dpr)))
sepdpr <- round(fight %>% filter(weapon == "sword") %>% summarize(sum = sum(dpr)))
thepdpr <- round(fight %>% filter(weapon == "twohander") %>% summarize(sum = sum(dpr)))

label_names_dpr <- as_labeller(c(`dagger` = paste0(depdpr, " total DPR"), 
                             `sword` = paste0(sepdpr, " total DPR"),
                             `twohander` = paste0(thepdpr, " total DPR")))

depdmg <- round(fight %>% filter(weapon == "dagger") %>% summarize(sum = sum(damage)))
sepdmg <- round(fight %>% filter(weapon == "sword") %>% summarize(sum = sum(damage)))
thepdmg <- round(fight %>% filter(weapon == "twohander") %>% summarize(sum = sum(damage)))

label_names_dmg <- as_labeller(c(`dagger` = paste0(depdmg, " total damage"), 
                             `sword` = paste0(sepdmg, " total damage"),
                             `twohander` = paste0(thepdmg, " total damage"))) 
```

```{r echo=FALSE, fig.cap="Comparison between the total DPR achieved by utilizing Execute after each attack, with varying weapon types."}
ggplot(fight, aes(x = time, y = dpr, colour = weapon)) +
        scale_x_continuous(breaks = seq(0, 20, by = 1.5)) +
        geom_point() + 
        facet_wrap(~ weapon, nrow = 3, labeller = label_names_dpr) +
        scale_colour_manual(values = cbp2,
                name = "Weapon",
                labels = c("Dagger", "One Hander", "Two Hander")) +
        scale_y_continuous(breaks = seq(40, 55, by = 5)) +
        labs(y = "Damage per Rage",
             x = "Execute phase length (s)",
             title = "Average Execute DPR by weapon type",
             subtitle = "Executing more often for less rage leads to higher DPR.")
```

```{r echo=FALSE, fig.cap="Comparison between the total damage achieved by utilizing Execute after each attack, with varying weapon types."}
ggplot(fight, aes(x = time, y = damage, colour = weapon)) +
        scale_x_continuous(breaks = seq(0, 20, by = 1.5)) +
        geom_point() + 
        facet_wrap(~ weapon, nrow = 3, labeller = label_names_dmg) +
        scale_colour_manual(values = cbp2,
                name = "Weapon",
                labels = c("Dagger", "One Hander", "Two Hander")) +
        # scale_y_continuous(breaks = seq(40, 55, by = 5)) +
        labs(y = "Damage",
             x = "Execute phase length (s)",
             title = "Average Execute damage by weapon type",
             subtitle = "Executing more often for less rage leads to higher damage.")
```

The graph is clear: utilizing daggers during the execute phase leads to much higher DPR efficiency than the alternatives. It is important to note, however, that the dagger could be replaced by **any** fast single handed weapon, provided it has high DPS. 
Knowing this, it stands to reason that switching to a fast weapon with comparable DPS just before the Execute phase would lead to higher overall DPR, and thus damage. This is what is called *execute switching*, and while it was highly effective on private servers, it is not as effective on World of Warcraft Classic for a few reasons:

* Execute phase lengths were much longer on private servers due to higher boss armor and HP pool. This increased the effectiveness of execute switching, as we can see in \@ref(fig:epl-exec).
* Execute in Classic is batched. This means that the game calculates how much rage you have upon the ability activation (and thus damage), but the damage is only dealt 400ms after that calculation. This means any rage generated in that window will **not** be taken into account when damage is dealt, but **will** be lost as if it did.


```{r Important Functions Relating to Execute phase DPR, include=FALSE}
oh_swing <- as_tibble((seq(from = 0 , 20, by = 1.6))) %>%
        mutate(weapon = "offhand") %>%
        rename(time = value) %>%
        mutate(swing_dmg = rnorm(mean = 82, sd = 3, n = 13)) %>%
        mutate(rage = rage_gen(swing_dmg)) %>%
        mutate(hit = 1)

execute_dpr <- function(start = 0, end = NULL, speed = NULL, avg_dmg = NULL, weapon_type = NULL, oh = "yes"){
                
        swing_tbl <- as_tibble(seq(from = start, to = end, by = speed)) %>%
                mutate(weapon = weapon_type) %>%
                rename(time = value) %>%
                mutate(swing_dmg = rnorm(mean = avg_dmg, sd = 3, n = length(seq_along(time)))) %>%
                mutate(hit = 1)
        if(oh == "yes"){
                swing_tbl <- swing_tbl %>%
                        mutate(rage = rage_gen(swing_dmg) + mean(oh_swing$rage)) 
        } else if(oh == "no"){
                swing_tbl <- swing_tbl %>%
                        mutate(rage = rage_gen(swing_dmg))
        }
        swing_tbl <- swing_tbl %>%
                mutate(damage = execute(rage),
                       dpr = damage/rage)
                
        # 
        # dpr_tbl <- tibble::tribble(
        #     ~`length`,      ~total_dpr,
        # end,   totaldprval
        # )
        return(swing_tbl)
}


total_dpr <- function(swing_tbl = NULL){
        totaldprval <- swing_tbl %>%
                select(dpr) %>%
                summarise(sum(dpr))
        return(totaldprval)
}


```

```{r include=FALSE}

## Refactor this section for the love of god
epl <- seq(5, 20, 5)

sword_20 <- execute_dpr(start = 0, end = 20, speed = 2.4, avg_dmg = 143, weapon_type = "sword", oh = "yes") %>%
        total_dpr() %>%
        mutate(epl = 20,
               weapon_type = "onehander") %>%
        rename(totaldpr = `sum(dpr)`)
sword_15 <- execute_dpr(start = 0, end = 15, speed = 2.4, avg_dmg = 143, weapon_type = "sword", oh = "yes") %>%
        total_dpr() %>%
        mutate(epl = 15,
               weapon_type = "onehander") %>%
        rename(totaldpr = `sum(dpr)`)
sword_10 <- execute_dpr(start = 0, end = 10, speed = 2.4, avg_dmg = 143, weapon_type = "sword", oh = "yes") %>%
        total_dpr() %>%
        mutate(epl = 10,
               weapon_type = "onehander")%>%
        rename(totaldpr = `sum(dpr)`)

sword_05 <- execute_dpr(start = 0, end = 05, speed = 2.4, avg_dmg = 143, weapon_type = "sword", oh = "yes") %>%
        total_dpr() %>%
        mutate(epl = 05,
               weapon_type = "onehander")%>%
        rename(totaldpr = `sum(dpr)`)




dagger_20 <- execute_dpr(start = 1.5, end = 20, speed = 1.5, avg_dmg = 105, weapon_type = "dagger", oh = "yes") %>%
        total_dpr() %>%
        mutate(epl = 20,
               weapon_type = "dagger") %>%
        rename(totaldpr = `sum(dpr)`)

dagger_15 <- execute_dpr(start = 1.5, end = 15, speed = 1.5, avg_dmg = 105, weapon_type = "dagger", oh = "yes") %>%
        total_dpr() %>%
        mutate(epl = 15,
               weapon_type = "dagger") %>%
        rename(totaldpr = `sum(dpr)`)

dagger_10 <- execute_dpr(start = 1.5, end = 10, speed = 1.5, avg_dmg = 105, weapon_type = "dagger", oh = "yes") %>%
        total_dpr() %>%
        mutate(epl = 10,
               weapon_type = "dagger") %>%
        rename(totaldpr = `sum(dpr)`)

dagger_05 <- execute_dpr(start = 1.5, end = 05, speed = 1.5, avg_dmg = 105, weapon_type = "dagger", oh = "yes") %>%
        total_dpr() %>%
        mutate(epl = 05,
               weapon_type = "dagger") %>%
        rename(totaldpr = `sum(dpr)`)


twohander_20 <- execute_dpr(start = 0, end = 20, speed = 3.3, avg_dmg = 258, weapon_type = "twohander", oh = "no") %>%
        total_dpr() %>%
        mutate(epl = 20,
               weapon_type = "twohander")%>%
        rename(totaldpr = `sum(dpr)`)

twohander_15 <- execute_dpr(start = 0, end = 15, speed = 3.3, avg_dmg = 258, weapon_type = "twohander", oh = "no") %>%
        total_dpr() %>%
        mutate(epl = 15,
               weapon_type = "twohander")%>%
        rename(totaldpr = `sum(dpr)`)

twohander_10 <- execute_dpr(start = 0, end = 10, speed = 3.3, avg_dmg = 258, weapon_type = "twohander", oh = "no") %>%
        total_dpr() %>%
        mutate(epl = 10,
               weapon_type = "twohander")%>%
        rename(totaldpr = `sum(dpr)`)

twohander_05 <- execute_dpr(start = 0, end = 05, speed = 3.3, avg_dmg = 258, weapon_type = "twohander", oh = "no") %>%
        total_dpr() %>%
        mutate(epl = 05,
               weapon_type = "twohander")%>%
        rename(totaldpr = `sum(dpr)`)

overall_totaldpr <- bind_rows(twohander_20,twohander_15,twohander_10,twohander_05,
                              sword_20, sword_15, sword_10, sword_05,
                              dagger_20, dagger_15, dagger_10, dagger_05) %>%
        mutate(weapon_type = as.factor(weapon_type))
```


The biggest factor determining the viability of Execute switching is the Execute phase length (EPL). While the difference between the Execute DPR of different weapon types and speeds is small in short EPLs, this effect becomes more noticeable as the EPL increases. This is, again, because the longer the duration of the EPL, the more opportunities we have to gain "free" damage from the activation of the Execute ability. This behavior can be observed in the graph below:

```{r epl-exec, echo=FALSE, fig.cap = "Total DPR achieved by utilizing Execute after every weapon swing with different weapons."}
ggplot(overall_totaldpr, aes(x = epl, y = totaldpr, colour = weapon_type)) +
        geom_point() +
        geom_line() +
         scale_colour_manual(values = cbp2,
                name = "Weapon Speed and Type",
                labels = c("1.5 (One Handed)", "2.4 (One Handed)", "3.3 (Two Handed)")) +
        scale_y_continuous(breaks = seq(100, 700, by = 100)) +
        labs(y = "Total Damage per Rage",
             x = "Execute phase length (s)",
             title = "Short Execute phase lengths make switching less effective.",
             subtitle = "Calculations account for 1.5 second offset caused by the weapon switch.")
```

## Heroic Strike and Cleave{#heroic}

Heroic Strike (HS) and Cleave are unique abilities in a warrior's toolkit. While all of the abilities we've looked at so far are instant - meaning they occur immediately upon activation - HS and Cleave instead take place on the player's *next* melee main hand swing. This has two important consequences:

1. Since the player's next melee attack becomes a yellow attack, it also gains the properties of one. This means HS and Cleave *cannot* glance.
2. Similarly, since the player's next melee swing is now a yellow attack, it *does not* generate rage. Therefore, HS and Cleave are utilized as rage dumps in order to prevent rage capping.

Because these abilities do not generate rage, their activation cost and damage are deceptive - we need to factor in the opportunity cost of a regular melee attack. Likewise, the damage dealt by these abilities has to account for the $P(Glance)$ reduction they incur. Therefore, from now on when we refer to HS and Cleave's cost and damage, we'll be speaking in terms of **effective cost** and **effective damage**. Beanna and Vilius [@beanna_fcdpr2019] have derived this formulas as:

Effective HS cost:

\begin{equation}
HS_{cost}\ = 15\ +\ \left(Rage\left(Dmg_{auto}\ \right)\right)-HS_{imp}
(\#eq:hscost)
\end{equation}

Effective HS damage:

\begin{equation}
\small HS_{dmg}\ =\ \left(1+P\left(Crit\right)-P\left(Doge\right)\times Damage\ +\ P\left(Glancing\right)\left(Damage_{auto}-Damage_{glance}\right)\right)
(\#eq:hsdmg)
\end{equation}

Analogously, we can define Cleave's effective cost as:

\begin{equation}
Cleave_{cost}\ = 20\ +\ \left(Rage\left(Dmg_{auto}\ \right)\right)
(\#eq:cleavecost)
\end{equation}

And its damage as:

\begin{equation}
\scriptsize Cleave_{dmg}\ =\ \left(1+P\left(Crit\right)-P\left(Dodge\right) \times \left(Dmg_{auto}+\ \left(2\ \times\ Cleave_{bonus}\ \right)\right)+\ \left(P\left(Glance\right)\times\left(Dmg_{auto}\ -\ Dmg_{glance}\right)\right)\right)
(\#eq:cleavedmg)
\end{equation}


```{r cleave and hs formulas, include=FALSE}
hs_cost <- function(dmg_auto, imp_hs = 3){
        cost = (15 + rage_gen(dmg_auto)-imp_hs) 
        return(cost)
}

hs_dmg <- function(crit = 0.3, dodge = 0.06, dmg_auto, ap, wpn_spd){
        apdmg = ad_dmg(ap, wpn_spd) 
        multiplier = (1+crit-dodge) * (dmg_auto + apdmg) # dodge is hardcoded as 0.06 due to 305 weapon skill
        glance = 0.4 * (dmg_auto - (0.85 * dmg_auto)) # 0.4 is P(glance) and 0.85 is hardcoded 305 wep skill
        damage = multiplier + glance + 138 # assuming highest rank hs
        return(damage)
        
        
}

cleave_cost <- function(dmg_auto){
        cost = 20 + rage_gen(dmg_auto)
        return(cost)
}

cleave_dmg <- function(crit = 0.3, dodge = 0.06, dmg_auto, ap, wpn_spd = 3.4, imp_cleave = 0, n = 2) {
        cleave_mult = 1 + (imp_cleave * 0.4)
        apdmg = ad_dmg(ap,wpn_spd)
        swingdmg = dmg_auto + apdmg
        bonus = 50 * cleave_mult
        multiplier = (1+crit-dodge) * (swingdmg + bonus)
        glance = 0.4 * (dmg_auto - (0.85 * dmg_auto)) # 0.4 is P(glance) and 0.85 is hardcoded 305 wep skill
        damage = n * (multiplier + glance)
        return(damage)
}
```

```{r hs cost and damage tables, include=FALSE}


dagger_hstbl <- tibble(
        swing = rnorm(mean = 105, sd = 4, n = 11000),
        ap = rep(ap_vals, length.out = 11000),
        damage = hs_dmg(dmg_auto = swing, ap = ap, wpn_spd = 1.5),
        cost = hs_cost(swing),
        dpr = damage / cost,
        weapon = "dagger"
)

onehand_hstbl <- tibble(
        swing = rnorm(mean = 143, sd = 4, n = 11000),
        ap = rep(ap_vals, length.out = 11000),
        damage = hs_dmg(dmg_auto = swing, ap = ap, wpn_spd = 2.4),
        cost = hs_cost(swing),
        dpr = damage / cost,
        weapon = "onehand"
)
twohand_hstbl <- tibble(
        swing = rnorm(mean = 258, sd = 4, n = 11000),
        ap = rep(ap_vals, length.out = 11000),
        damage = hs_dmg(dmg_auto = swing, ap = ap, wpn_spd = 3.4),
        cost = hs_cost(swing),
        dpr = damage / cost,
        weapon = "twohand"
)

hstbl <- bind_rows(dagger_hstbl, onehand_hstbl, twohand_hstbl) %>% 
        mutate(ability = "Heroic Strike")


dagger_clvtbl <- tibble(
        swing = rnorm(mean = 105, sd = 4, n = 11000),
        ap = rep(ap_vals, length.out = 11000),
        damage = (cleave_dmg(dmg_auto = swing, ap = ap, wpn_spd = 1.5)),
        cost = cleave_cost(swing),
        dpr = damage / cost,
        weapon = "dagger"
)

onehand_clvtbl <- tibble(
        swing = rnorm(mean = 143, sd = 4, n = 11000),
        ap = rep(ap_vals, length.out = 11000),
        damage = (cleave_dmg(dmg_auto = swing, ap = ap, wpn_spd = 2.4)),
        cost = cleave_cost(swing),
        dpr = damage / cost,
        weapon = "onehand"
)
twohand_clvtbl <- tibble(
        swing = rnorm(mean = 258, sd = 4, n = 11000),
        ap = rep(ap_vals, length.out = 11000),
        damage = (cleave_dmg(dmg_auto = swing, ap = ap, wpn_spd = 3.4)),
        cost = cleave_cost(swing),
        dpr = damage / cost,
        weapon = "twohand"
)

clvtbl <- bind_rows(dagger_clvtbl, onehand_clvtbl, twohand_clvtbl) %>% 
        mutate(ability = "Cleave")

twohand_slamtbl <- tibble(
        swing = rnorm(mean = 258, sd = 4, n = 11000),
        ap = rep(ap_vals, length.out = 11000),
        damage = slam(wpn_swing_dmg = swing, ap = ap, wpn_spd = 3.4),
        cost = 15,
        dpr = damage / cost,
        weapon = "twohand",
        ability = "Slam"
)

onehand_slamtbl <- tibble(
        swing = rnorm(mean = 243, sd = 4, n = 11000),
        ap = rep(ap_vals, length.out = 11000),
        damage = slam(wpn_swing_dmg = swing, ap = ap, wpn_spd = 2.3),
        cost = 15,
        dpr = damage / cost,
        weapon = "onehand",
        ability = "Slam"
)

```

It's important to note that, due to the player's weapon swing ultimately affecting the effective cost of both abilities, their DPR also changes according to the weapon's average damage. We can visualize this behavior through violin plots:

```{r echo=FALSE, fig.cap="Visualization of the effective HS damage and DPR density for different weapon types."}
hstbl %>% 
        filter(ap == 0) %>%
ggplot(aes(y = damage, x = cost, fill = weapon)) +
        geom_violin(alpha = 0.5) +
        scale_fill_manual(values = cbp2,
        name = "Weapon Type",
        labels = c("Dagger", "One Handed", "Two Handed")) +
        scale_x_continuous(breaks = seq(15, 40, by = 5),
                                limits = c(15, 40)) +
        labs(y = "Damage",
             x = "Effective DPR",
             title = "HS effective DPR increases with average weapon damage",
             subtitle = "10000 swings with sd = 4")
```

```{r echo=FALSE, fig.cap="Visualization of the effective Cleave damage and DPR density for different weapon types."}
clvtbl %>% 
        filter(ap == 0) %>% 
ggplot(aes(y = damage, x = cost, fill = weapon)) +
        geom_violin(alpha = 0.5) +
        scale_fill_manual(values = cbp2,
        name = "Weapon Type",
        labels = c("Dagger", "One Handed", "Two Handed")) +
        scale_x_continuous(breaks = seq(15, 40, by = 5),
                                limits = c(15, 40)) +
        labs(y = "Damage",
             x = "Effective DPR",
             title = " Cleave effective DPR increases with average weapon damage",
             subtitle = "10000 swings with sd = 4, assuming Cleave hits two targets.")
```




### HS Queuing{#hsq}

In Classic World of Warcraft, the act of queueing a "on next attack" ability such as HS and Cleave introduces another mechanic. When this occurs, *the DW penalty on your OH swing is removed* \@ref(eq:dwmissprob), which essentially makes the player's OH swing as if he only had one one-handed weapon equipped. This introduces another layer of nuance in the warrior's rotation - repeatedly queueing and cancelling your HS queue will lead to an increase in OH hits, and therefore rage and DPS. It is important to note, however, that with world buffs most warriors are already able to HS every swing. Therefore, it is only recommended that one attempts this HS queue weaving when rage starved, as abilities and items such as Windfury Totem and Hand of Justice may result in the HS inadvertently going off - which may render the player unable to BT or WW on cooldown, resulting in a DPS loss.


## Slam{#slam}

Slam is a 1.5 second cast time ability that costs 15 rage and deals your weapon damage plus an additional 87 damage. Its cast time reduced by 0.1 for each point in the Improved Slam talent, and it is important to note that unlike Whirlwind, Slam is **not** speed normalized - meaning slower weapons will increase the ability's damage. Slam has been historically shunned as an ability in the warrior toolkit, largely due to its cast time: this posed significant usage problems in movement and damage heavy fights, as the player is unable to move and suffers damage pushback when casting. Moreover, even under ideal circumstances, Slam had the potential to be actively detrimental - mistiming it after your white swing landed meant that you'd clip your next auto, incurring a DPS loss.

\begin{equation}
Slam_{dmg}\ = Wep_{swing}\ +\ \left(AP\ \times\ \left(\frac{Wep_{speed}}{14}\right)\right) + 87
(\#eq:slamdmg)
\end{equation}

At the release of Classic, there was a bug that caused activating Slam when its cast time is equal to or less than the remaining time on your autoattack effectively lets the player bypass anything that would reset his swingtimer, resulting in the enemy being struck by both the auto attack and Slam upon a finished cast. This was achieved through the following macro:

```
#showtooltip
/stopattack
/cast Slam
/startattack
```
This bug was fixed [@blizz_2020autoslam], and Slam now works like it did on most private servers - meaning it is best utilized immediately after landing a white hit. Keep in mind that while the calculations below assume **perfect** Slam usage - i.e no auto attack clipping as a result of the activation of the ability - this is unrealistic. As such, Slam is significantly worse than it's pre-fix state, but still a better alternative than Hamstring spam if utilized correctly.

In order to assert the ability priority when utilizing Slam, let's first look at its DPR when used with two "tiers" of two handed weapons available to us in Phase 1 and 2 of World of Warcraft Classic:

* Tier 1, which includes Spinal Reaper, Hand of Ragnaros, and Bonereaver's Edge
* Tier 2, which includes Obsidian Edged Blade, Earthshaker, and The Unstoppable Force.


```{r include=FALSE}
tier1_2h <- sapply(ap_vals, slam, wpn_spd = 3.4, wpn_swing_dmg = 261)
tier2_2h <- sapply(ap_vals, slam, wpn_spd = 3.4, wpn_swing_dmg = 227)


tier1_2h_comparison <- as_tibble(cbind(ap_vals, tier1_2h)) %>%
        pivot_longer(-ap_vals, names_to = "source") %>%
        rename(damage = value) %>%
        mutate(dpr = damage/15)

tier2_2h_comparison <- as_tibble(cbind(ap_vals, tier2_2h)) %>%
        pivot_longer(-ap_vals, names_to = "source") %>%
        rename(damage = value) %>%
        mutate(dpr = damage/15)




slam_comparison <- bind_rows(tier1_2h_comparison, tier2_2h_comparison) %>%
        mutate(dpr = damage/15)


slam_comparison <- bind_rows(slam_comparison, btdmg_slam)



```

### Slam vs Bloodthirst

```{r echo=FALSE, fig.cap = "Comparison between Bloodthirst and Slam DPR with two different tiers of weapons."}
ggplot(slam_comparison, aes(x = ap_vals, y = dpr, color = source )) +
        geom_point() +
        geom_line() +
        scale_colour_manual(values = cbp2,
                name = "Weapon",
                labels = c("Bloodthirst", "Tier 1", "Tier 2")) +
        # scale_y_continuous(breaks = seq(100, 700, by = 100)) +
        labs(y = "DPR",
             x = "AP",
             title = "Slam's DPR is much higher than Bloodthirst's.")
```

As we can see, Slam's DPR is much higher than Bloodthirst's, particularly at lower attack power levels. This means in rage starved situations, the player should prioritize utilizing Slam over Bloodthirst. It is important to note, however, that just because Slam's DPR is higher even at very large attack power levels, that doesn't mean that its **damage** is also higher than Bloodthirst's. We can visualize this behavior with the following graph:

```{r echo=FALSE, fig.cap = "Comparison between Bloodthirst and Slam damage with two different tiers of weapons."}
ggplot(slam_comparison, aes(x = ap_vals, y = damage, color = source )) +
        geom_point() +
        geom_line() +
        scale_colour_manual(values = cbp2,
                name = "Weapon",
                labels = c("Bloodthirst", "Tier 1", "Tier 2")) +
        # scale_y_continuous(breaks = seq(100, 700, by = 100)) +
        labs(y = "Damage",
             x = "AP",
             title = "At 1500 AP Bloodthirst will, on average, do the same damage as Slam.",
             subtitle = "Bloodthirst outscales Slam with more AP, as expected.")
```

The graphs clearly show that while always more cost effective, Slam's damage is lower than Bloodthirst's past 1500 attack power when wielding a Tier 2 weapon, and and past 1700 when wielding a Tier 1 weapon - both easily achievable thresholds. What this effectively means is that Bloodthirst should be utilized as a priority if the player has over 1500 AP, keeping the previously understood ability priority. If the player is rage starved, however, Slam should be utilized as the more cost effective choice.

### Slam vs Execute

Slam's high DPR, combined with Execute's poor DPR while wielding a two-handed weapon, begs the question: which one is more effective? We can visualize and investigat this scenario through the following graph:
```{r include=FALSE}
slam_comparison

slam_epl <- as_tibble(seq(0, 20, by = 3.4)) %>%
        rename(time = value) %>%
        mutate(ability = "slam",
               hit = 1,
                damage = slam(rnorm(6, 261, 3), 3.4, 1500),
               dpr = damage/15)

exec_epl <- as_tibble(seq(0, 20, by = 3.4)) %>% 
        rename(time = value) %>% 
        mutate(ability = "execute",
                hit = 1,
                rage = rage_gen(rnorm(mean = 261, sd = 3, n = 6)),
                damage = execute(rage, points = 2),
                dpr = damage/rage)

slam_exec_comparison <- bind_rows(slam_epl, exec_epl)

slam_dprtot <- round(slam_exec_comparison %>% filter(ability == "slam") %>% summarize(sum = sum(dpr)))
exec_dprtot <- round(slam_exec_comparison %>% filter(ability == "execute") %>% summarize(sum = sum(dpr)))

slam_damagetot <- round(slam_exec_comparison %>% filter(ability == "slam") %>% summarize(sum = sum(damage)))
exec_damagetot <- round(slam_exec_comparison %>% filter(ability == "execute") %>% summarize(sum = sum(damage)))


label_names_epl <- as_labeller(c(`execute` = paste0(exec_dprtot, " total DPR", sep = " "), 
                                 `slam` = paste0(slam_dprtot, " total DPR", sep = " "))) 

label_names_epl_dmgtot <- as_labeller(c(`execute` = paste0(exec_damagetot, " total damage", sep = " "),
                                        `slam` = paste0(slam_damagetot, " total damage", sep = " "))) 



# 
# slam_epl <- as_tibble(seq(0, 2500, by = 250)) %>%
#         rename(ap = value) %>% 
#         mutate(ability = "slam",
#                 damage = slam(rnorm(11, 261, 3), 3.3, ap),
#                 rage = 15,
#                 dpr = damage/rage)
# 
# exec_epl <- as_tibble(seq(0, 20, by = 1.3)) %>% 
#         rename(time = value) %>% 
#         mutate(ability = "execute",
#                hit = 1,
#                rage = seq(10, 100, by = 5),
#                damage = execute(rage, 2),
#                dpr = damage / rage)

```

```{r echo=FALSE, fig.cap = "Comparison between Slam and Execute DPR during a 20 second long execute phase."}
ggplot(slam_exec_comparison, aes(x = time, y = dpr, colour = ability)) +
        scale_x_continuous(breaks = seq(0, 20, by = 1.5)) +
        geom_point() + 
        facet_wrap(~ ability, nrow = 2, labeller = label_names_epl) +
        scale_colour_manual(values = cbp2,
                name = "Ability",
                labels = c("Execute", "Slam")) +
        # scale_y_continuous(breaks = seq(40, 55, by = 5)) +
        labs(y = "Damage per Rage",
             x = "Execute phase length (s)",
             title = "Based on average rage generated per hit, Slam shows slightly higher DPR than Execute.",
             subtitle = "Assuming 1500 AP and an average weapon swing damage of 261.")

```


The dots represent an ability usage. The large auto attack damage resulting from a two handed weapon swing also results in more rage, reducing the overall DPR in the time period. We know, however, that DPR and Damage are not strictly proportional. Therefore, under the same circumstances, let's look at the damage dealt in the same time interval:

```{r echo=FALSE, fig.cap="Comparison between the total damage dealt by Slam and Execute while wielding a two handed weapon during a 20 second long execute phase."}

ggplot(slam_exec_comparison, aes(x = time, y = damage, colour = ability)) +
        scale_x_continuous(breaks = seq(0, 20, by = 1.5)) +
        geom_point() + 
        geom_line() +
        facet_wrap(~ ability, nrow = 2, labeller = label_names_epl_dmgtot) +
        scale_colour_manual(values = cbp2,
                name = "Ability",
                labels = c("Execute", "Slam")) +
        # scale_y_continuous(breaks = seq(40, 55, by = 5)) +
        labs(y = "Damage",
             x = "Execute phase length (s)",
             title = "Slam and Execute damage are comparable post Autoslam nerf.",
             subtitle = "Assuming 1500 AP, average weapon swing damage of 258, and optimal Execute DPR.")
```

The graph shows Slam and Execute dealing virtually the same damage. However, it is important to note that Slam scales with attack power and  weapon swing damage, *and* the graph does not account for possible Bloodthirsts that could be weaved in given enough rage. This effectively means the at lower gear levels, the player should still Slam over Execute throughout the execute phase - even if the difference between the two abilities is now much smaller. An important note is that if the boss is about to die and the player has a large surplus of rage, the potential damage of Execute is much higher than that of Slam and it should therefore be the ability of choice.

```{r cleave vs slam, include= FALSE}

# Use ad_dmg formula to calculate additional damage to cleave at varying levels of ap

cleave_vs_slam <- bind_rows(twohand_slamtbl, clvtbl, onehand_slamtbl, hstbl)
```


### Slam vs Cleave and Heroic Strike

The same damage and DPR comparison can be made between Cleave, Heroic Strike, and Slam. Let's first compare the effective DPR of these abilities:

```{r echo=FALSE, fig.cap = "Comparison between Cleave, Heroic Strike, and Slam mean DPR at varying attack power levels."}
cleave_vs_slam %>%
        filter(weapon == "twohand") %>%
        group_by(ap,ability) %>%
        summarise(meandpr = mean(dpr),
                  meandamage = mean(damage)) %>%
        ggplot(
                aes(x = ap, y = meandpr, color = ability)
        ) +
        geom_point() +
        geom_line() +
        scale_colour_manual(values = cbp2,
        name = "Ability",
        labels = c("Cleave", "Heroic Strike", "Slam")) +
        labs(y = "Mean DPR",
             x = "Attack Power",
             title = "Slam has much higher DPR than either ability.",
             subtitle = "Assuming Cleave hits two targets, and a mean weapon swing of 258.")
```

It should not be surprising by now that Slam is the clear winner when it comes to DPR. It is important to note, however, that the context under which these abilities are utilized is different: Cleave and Heroic Strike are abilities utilized to dump extra rage with while Slam, due to its low rage cost, is not utilized in the same fashion. Let's instead look at the damage dealt by these abilities, under the same circumstances:

```{r echo = FALSE, fig.cap = "Comparison between Cleave, Heroic Strike, and Slam mean damage at varying attack power levels."}

cleave_vs_slam %>%
        filter(weapon == "twohand") %>%
        group_by(ap,ability) %>%
        summarise(meandpr = mean(dpr),
                  meandamage = mean(damage)) %>%
        ggplot(
                aes(x = ap, y = meandamage, color = ability)
        ) +
        geom_point() +
        geom_line() +
        scale_colour_manual(values = cbp2,
        name = "Ability",
        labels = c("Cleave", "Heroic Strike", "Slam")) +
        labs(y = "Mean Damage",
             x = "Attack Power",
             title = "Cleave damage increase outpaces Slam's with larger AP values",
             subtitle = "Assuming Cleave hits two targets, and a mean weapon swing of 258.")
```

There's a lot to take away from these two graphs:

1. Slam is, by far, the your highest DPR ability while wielding a two handed weapon. As such, it should be prioritized in low-rage situations.
2. Although Slam's DPR is higher than that of Cleave's, its damage is significantly lower in a two-target situation. Therefore, Cleave should be prioritized when the player has sufficient rage and 2 or more targets.
3. While the damage difference between Heroic Strike and Slam is small, the DPR gap is very high. This means HS should *never* be utilized while wielding a two handed weapon when the player could otherwise Slam.



```{r echo=FALSE}
# cleave_vs_slam %>%
#         filter(weapon == "twohand") %>%
#         # group_by(ap,ability) %>%
#         # summarise(meancost = mean(cost),
#         #           meandamage = mean(damage)) %>%
#         ggplot(
#                 aes(y = ability, x = damage)
#         ) +
#         geom_density_ridges_gradient()
#         # scale_fill_manual(values = cbp2,
#         # name = "Ability",
#         # labels = c("Cleave", "Heroic Strike", "Slam")) +
#         # # scale_y_continuous(breaks = seq(40, 55, by = 5)) +
#         # labs(y = "Mean Damage",
#         #      x = "Mean Rage Cost",
#         #      title = "Despite the damage difference between the abilities, Slam has much higher DPR",
#         #      subtitle = "blabla")
```


## Hamstring{#hamstring}

1. Intro to Hamstring
2. Why use Hamstring?

## Overpower{#overpower}

1. Intro to Overpower
2. Should you use OP? If so, when?

## Battle Shout{#battleshout}

1. Intro to battle shout
2. How much does battle shout add, on average, to our abilities
3. Improved battle shout, how good is it?

## Damage per Rage{#dpr}

1. Damage per Rage comparison between main rotational abilities (BT, WW, Exec, Slam)
2. The impact of scaling on DPR, and how that affects your rotation

## The Warrior Priority System

1. The Warrior Priority System

<!--chapter:end:03-abilities_rotation.Rmd-->


```{r include=FALSE}

library(janitor)
library(tidyverse)
library(ggplot2)
library(ggridges)
library(gghighlight)
theme_set(theme_light())

# The palette with grey:
cbp1 <- c("#999999", "#E69F00", "#56B4E9", "#009E73",
          "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

# The palette with black:
cbp2 <- c("#000000", "#E69F00", "#56B4E9", "#009E73",
          "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

ad_dmg <- function(ap, wpn_spd){
        added_dmg = ap * (wpn_spd/14)
        return(added_dmg)
}

bt <- function(ap, crit = 0.3, dodge = 0.06){
        multiplier = 1+crit-dodge
        damage = multiplier * (ap * 0.45)
        return(damage)
}

# execute <- function(rage, crit = 0.3, dodge = 0.06){
#         damage = multiplier * (600 + ((rage-10)*15))
#         return(damage)
# }

ap_vals <- seq(0, 2500, by = 250)

execute <- function(rage, points = 2, crit = 0.3, dodge = 0.06, multiplier = TRUE){
        if (rage > 100){rage = 100}
        if(points == 0){
                added = rage-15
        } else if (points == 1){
                added = rage-13
        } else if (points == 2){
                added = rage-10
        }
        
        if(multiplier == TRUE){
                
                multiplier = 1+crit-dodge
                damage = (600 + (added*15)) * multiplier
                
        } else if (multiplier == FALSE){
                
                damage = (600 + (added*15))
        }
        return(damage)
}


ww <- function(wpn_swing_dmg, wpn_spd, ap, crit = 0.3, dodge = 0.06){
        multiplier = 1+crit-dodge
        additional = ad_dmg(ap, wpn_spd)
        total = wpn_swing_dmg + (additional)
        damage = multiplier * total
        return(damage)
}

slam <- function(wpn_swing_dmg, wpn_spd = 3.3, ap, crit = 0.3, dodge = 0.06){
        additional = (ad_dmg(ap, wpn_spd)) + 87
        total = wpn_swing_dmg + (additional)
        multiplier = 1+crit-dodge
        damage = multiplier * total
        return(damage)
}

conversion_values_tbl <- tibble::tribble(
        ~`Player Level`,    ~`Conversion Value`,
                   10,  37.4,
                   20,  72.4,
                   30, 109.3,
                   40, 147.9,
                   50, 188.3,
                   60, 230.6
        )

hit_factor_tbl <- tibble::tribble(
            ~`Weapon`,      ~`Hit Type`,   ~`Hit factor`,
        "Main Hand",   "Normal Hit",  3.5,
        "Main Hand", "Critical Hit",    7,
         "Off Hand",   "Normal Hit", 1.75,
         "Off Hand", "Critical Hit",  3.5
        )

ap_thresh <- as.data.frame(seq(0, 3000, 100))
bt_dmg <- as.data.frame(lapply(ap_thresh, bt))
bt_dmg <- bind_cols(ap_thresh, bt_dmg)
bt_dmg <- bt_dmg %>%
        unnest() %>%
        transmute(AP = `seq(0, 3000, 100)`,
                  Damage = `seq.0..3000..100.`) %>%
        mutate(dpr = Damage/30)

# bt_dmg_exec <- as_tibble(cbind(ap_vals, btdmg)) %>%
#         rename(damage = btdmg) %>%
#         mutate(source = "bloodthirst") %>%
#         mutate(dpr = damage/30)
btdmg <- sapply(ap_vals, bt)
btdmg_slam <- as_tibble(cbind(ap_vals, btdmg)) %>%
        rename(damage = btdmg) %>%
        mutate(source = "bloodthirst") %>%
        mutate(dpr = damage/30)

rage_gen <- function(D){
        rage_gen <- ((D/230.6) * 15)
        return(rage_gen)
}


```

# Cooldowns{#cds}

Much of DPSing in WoW Classic is about timing your offensive cooldowns. In order to utilize these most efficiently, we need to have a good grasp of two main factors:

1. What the kill time for the boss is.
2. The highest DPS phase in any given fight.

The most efficient way to utilize cooldowns is to ensure they are up throughout the entire fight, which can be achieved by having the kill time for the boss be equal to or lower than the duration of your cooldowns. While this is can be done for Recklessness, it is much more likely to happen for Death Wish (which lasts twice as long). Failing that, the player must identify what the highest DPS phase of the fight is, which while straightforward for single target fights (Execute phase), is not **always** the case for cleave fights. We'll recall that the DPR (and thus DPS) potential of Whirlwind is very high in cleave situations, especially depending on your weapon. Therefore, it's up to the player - based on his current gear setup - to identify whether utilizing cooldowns for the cleave portion of the fight is better than saving it for the Execute phase if these two do not overlap.

Another important factor is that cooldowns are synergistic. This means that utilizing Death Wish in conjunction with Recklessness results in a much greater DPS increase than staggering both. Moreover, as a rule of thumb, it is better to utilize your cooldowns too early rather than too late - seconds left on your buffs after the boss dies do not add to your damage.

## Death Wish

Death Wish (DW) is a 3 minute cooldown which costs 10 rage, lasts 30 seconds, and increases the player's physical damage by 20% while also granting Fear immunity, but reducing armor and all resistances by 20%. In a pure single target fight, DW should expire *just* as the boss dies for maximum efficiency. Like all cooldowns other cooldowns, it is particularly effective when coupled with others cooldowns.

## Recklessness

Recklessness (Reck) causes most (all) attacks the player makes to be critical for the next 15 seconds, but all damage taken is increased by 20%. It follows the same general cooldown rules outlined above, with the caveat that this will highly increase the threat done by the applier. As such, it is recommended that the player either coordinates with the main tank in its usage, or be sure that they will not surpass the tank in threat.

## Trinkets
### Diamond Flask

Diamond Flask (DF) is a warrior class quest reward which increases your strength by 75 for one minute while also giving the player 9 health every 5 seconds, on a 6 minute cooldown. This is an exceptionally strong cooldown which should be utilized in all fights lasting one minute or less, as the strength buff translates to an AP increase of 150. Since this AP increase is static throughout the duration of the buff, we can simply average it over the fight duration to find its relative AP increase for any given fight length. Knowing this, we can calculate whether we should utilize DF on a fight over other trinkets if we know their equivalent attack power value.

## Mighty Rage Potion

Mighty Rage Potion (MRP) is a potion on a 2 minute cooldown, which when utilized increases the player's rage by 45 to 75 and their strength by 60 for 20 seconds. This rage increasing effect makes MRP utilization a bit more nuanced than our other cooldowns: while its AP increasing effect would result in increased BT damage, its rage increasing effect would result in increased Execute damage. Therefore, a commonly asked question is: should the player utilize MRP for its AP increase over the duration of the effect, or should he utilize it for the rage spike during Execute phase? Let's compare the following scenarios: 

1. A player with 305 weapon skill, a Chromatically Tempered Sword, 30% $P(Crit)$, and 2000 AP utilizes MRP at $t = 0$, outside of Execute phase.
2. The same player utilizes MRP immediately after his first Execute when his rage is zero, and the Execute phase lasts for 5 more seconds.


```{r message=FALSE, warning=FALSE, include=FALSE}

# Scenario 1 no MRP

sce1_bt <- tibble(
        ap = 2000,
        skill = "Bloodthirst",
        damage = bt(ap = ap),
        time = c(0, 6, 18)
)

sce1_mh <- tibble(
        ap = 2000,
        skill = "MH Swing",
        damage = (rnorm(9, mean = 152, sd = 3) + ad_dmg(ap = ap, wpn_spd = 2.4)) * 1.24,
        time = seq(from = 0, to = 20, by = 2.4)
)

sce1_ww <- tibble(
        ap = 2000,
        skill = "Whirlwind",
        damage = rnorm(2, mean = ww(wpn_swing_dmg = 152, ap = ap, wpn_spd = 2.4)),
        time = seq(from = 1.5, to = 20, by = 10)
)

scenario1 <- bind_rows(sce1_bt, sce1_mh, sce1_ww) %>% 
        mutate(MRP = "Without MRP")

# scenario1 %>% 
#         ggplot(aes(x = time, y = damage, colour = skill)) +
#         geom_point() +
#         geom_line() +
#         scale_colour_manual(values = cbp2,
#                 name = "Damage Source", 
#                 labels = c("Bloodthirst", "MH Swing", "Whirlwind")) +
#         labs(x = "Time",
#              y = "Damage",
#              title = "Cool title",
#              subtitle = "Something")

scenario1_tot <- round(scenario1 %>% summarize(sum = sum(damage)))



 
```

```{r message=FALSE, warning=FALSE, include=FALSE}
set.seed(1234)
# Scenario 1 with MRP

sce1mrp_bt <- tibble(
        ap = 2120,
        skill = "Bloodthirst",
        damage = bt(ap = ap),
        time = c(0, 6, 18)
)

sce1mrp_mh <- tibble(
        ap = 2120,
        skill = "MH Swing",
        damage = (rnorm(9, mean = 152, sd = 3) + ad_dmg(ap = ap, wpn_spd = 2.4)) * 1.24,
        time = seq(from = 0, to = 20, by = 2.4)
)

sce1mrp_ww <- tibble(
        ap = 2120,
        skill = "Whirlwind",
        damage = rnorm(2, mean = ww(wpn_swing_dmg = 152, ap = ap, wpn_spd = 2.4)),
        time = seq(from = 1.5, to = 20, by = 10)
)

scenario1mrp <- bind_rows(sce1mrp_bt, sce1mrp_mh, sce1mrp_ww) %>% 
        mutate(MRP = "With MRP")


# scenario1mrp %>% 
#         ggplot(aes(x = time, y = damage, colour = skill)) +
#         geom_point() +
#         geom_line() +
#         scale_colour_manual(values = cbp2,
#                 name = "Damage Source", 
#                 labels = c("Bloodthirst", "MH Swing", "Whirlwind")) +
#         labs(x = "Time",
#              y = "Damage",
#              title = "Cool title",
#              subtitle = "Something")

scenario1mrp_tot <- round(scenario1mrp %>% summarize(sum = sum(damage)))

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Plotting
# 
# label_names_scenarios <- as_labeller(c
#                                         (`scenario1` = paste0(scenario1_tot, " total Damage"),
#                                         `scenario1mrp` = paste0(scenario1mrp_tot, " total Damage")))

sce1_comparison <- bind_rows(scenario1mrp, scenario1)

ggplot(sce1_comparison, aes(x = time, y = damage, colour = skill)) +
        scale_x_continuous(breaks = seq(0, 20, by = 1.5)) +
        geom_point() +
        # geom_line() +
        facet_wrap(~ MRP, nrow = 2) +
        scale_colour_manual(values = cbp2,
                name = "Damage Source", 
                labels = c("Bloodthirst", "MH Swing", "Whirlwind")) +
        # scale_y_continuous(breaks = seq(40, 55, by = 5)) +
        labs(y = "Damage",
             x = "Time (s)",
             title = paste0("Utilizing MRP for it's length increases damage by ", (scenario1mrp_tot - scenario1_tot), " on average."),
             subtitle = paste0("This is equivalent to a ", (scenario1mrp_tot - scenario1_tot)/20, " DPS increase."))
```


```{r message=FALSE, warning=FALSE, include=FALSE}
set.seed(1234)

# Scenario 2 no MRP


sce2_mh <- tibble(
        ap = 2000,
        skill = "MH Swing",
        damage = (rnorm(3, mean = 152, sd = 3) + ad_dmg(ap = ap, wpn_spd = 2.4)) * 1.24,
        time = seq(from = 0, to = 5, by = 2.4),
        rage = rage_gen(D = damage)
)

sce2_exe <- tibble(
        ap = 2000,
        skill = "Execute",
        rage = c(40, 12, 40, 12),
        damage = execute(rage = rnorm(4, mean = rage, sd = 3)),
        time = seq(from = 0, to = 5, by = 1.5)
        
)

scenario2 <- bind_rows(sce2_mh, sce2_exe) %>% 
        mutate(MRP = "Without MRP")
scenario2_tot <- round(scenario2 %>% summarize(sum = sum(damage)))


## Scenario 2 with MRp

sce2_mrp_mh <- tibble(
        ap = 2120,
        skill = "MH Swing",
        damage = (rnorm(3, mean = 152, sd = 3) + ad_dmg(ap = ap, wpn_spd = 2.4)) * 1.24,
        time = seq(from = 0, to = 5, by = 2.4),
        rage = rage_gen(D = damage)
)

sce2_mrp_exe <- tibble(
        ap = 2120,
        skill = "Execute",
        rage = c(40, 60, 40, 12),
        damage = execute(rage = rnorm(4, mean = rage, sd = 3)),
        time = seq(from = 0, to = 5, by = 1.5)
        
)

scenario2_mrp <- bind_rows(sce2_mrp_mh, sce2_mrp_exe) %>% 
        mutate(MRP = "With MRP")
scenario2_mrp_tot <- round(scenario2_mrp %>% summarize(sum = sum(damage)))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
sce2_comparison <- bind_rows(scenario2_mrp, scenario2)

ggplot(sce2_comparison, aes(x = time, y = damage, colour = skill)) +
        scale_x_continuous(breaks = seq(0, 20, by = 1.5)) +
        geom_point() +
        # geom_line() +
        facet_wrap(~ MRP, nrow = 2) +
        scale_colour_manual(values = cbp2,
                name = "Damage Source", 
                labels = c("Execute", "MH Swing")) +
        # scale_y_continuous(breaks = seq(40, 55, by = 5)) +
        labs(y = "Damage",
             x = "Time (s)",
             title = paste0("Utilizing MRP for its rage spike increase damage by ", (scenario2_mrp_tot - scenario2_tot), " on average."),
             subtitle = paste0("This is equivalent to a ", (scenario2_mrp_tot - scenario2_tot)/20, " DPS increase."))
```

As we can see, utilizing MRP to increase the damage of a single Execute will result in higher damage on average. It is important to note, however, that this method is subject to a lot more variance: missing one or more Executes will result in a much bigger DPS loss than if the player had utilized MRP for its length. Therefore, this is a situation where the player has to weigh risk versus reward. Moreover, if we extrapolate these results, we can clearly see that utilizing MRP for rage *while* getting the full length benefit of it's AP increase is the most optimal method of utilization.

## Bloodrage

Bloodrage is an ability that instantly generates 10 rage, and another 10 over 10 seconds. It has a one minute cooldown and puts the player in combat upon activation. There are a few main uses for Bloodrage:

1. Activating Battle Shout before combat starts if not already buffed by it.
2. Mitigating unlucky dodge streaks that might interfere with BT usage.
3. As a "mini MRP" to increase Execute damage.
4. If out of rage and knocked back, to get back in rage with Intercept.

This ability gives free rage, and thus should be utilized multiple times during fights which accomodate its usage.

## Berserker Rage

Berserker Rage is an instant ability on a 30 second cooldown which causes the player to become immune to Fear and Incapacitate effects, while also generating extra rage when taking damage. It is important to note that since it lasts 10 seconds, activating the spell pre-emptively during "empty" GCDs will often enable the player to circumvent every Fear on a boss fight (such as Nefarian) depending on the timer, whereas activating it *after* being feared would cause the player to sometimes lose precious seconds being unable to attack. Many fights also contain predictable raid-wide damage, which are prime opportunities for the activation of Berserker Rage and thus increased rage generation.

<!--chapter:end:04-cooldowns.Rmd-->

# Consumables{#consums}
## Required
### Mongoose
### Juju/Giants
### Firewater/Juju
### R.O.I.D.S and Scorpok
## Protection Potions
## Assorted
### Limited Invulnerability Potions
### Restorative Potions
### Free Action Potions

<!--chapter:end:05-consumables.Rmd-->

# Parsing{#parsing}

1. Intro to parses
2. How parses can be gamed
3. Your parse does not define how good of a player you are
4. Parses can still be very useful

## Factors Affecting Parses

### World Buffs

1. List obtainbale world buffs
2. Lay out the value you get from them
3. World buffs are essential if you want to parse highly.

### Kill Time & Raid DPS

1. Your guild is the most important factor in whether you'll parse well or not.
2. Your guild DPS severely impact your parses
        i. High guild DPS is essential
        ii. Fitting a boss kill within a Reck/DW window.

### "What did I do wrong?"

1. Importance of critical self evaluation
2. How to look at your own parses and evaluate your performance
        a. BT casts per minute and interval between BTs
        b. Boss uptime and the importance of Charge and Intercept
        c. Cooldown timings

<!--chapter:end:06-parses.Rmd-->

`r if (knitr::is_html_output()) '
# References {-}
'`

<!--chapter:end:09-references.Rmd-->

